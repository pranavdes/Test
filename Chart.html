<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta tags for character encoding and responsive design -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Page title -->
    <title>Enhanced QA Review Analytics Dashboard</title>
    
    <!-- External library imports for Chart.js functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    
    <!-- Placeholder for CSS styles - will be provided in Part 2 -->
    <style>
        /* ===========================================
           PART 2: CSS STYLING & RESPONSIVE DESIGN
           =========================================== */
        
        /* ===== BASE STYLES & RESET ===== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            line-height: 1.6;
            color: #333;
        }
        
        /* ===== MAIN CONTAINER LAYOUT ===== */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        /* Header styling with gradient background */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 300;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 16px;
        }
        
        /* ===== DASHBOARD GRID LAYOUT ===== */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            padding: 20px;
            min-height: calc(100vh - 200px);
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow: hidden;
        }
        
        .sidebar {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            height: fit-content;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }
        
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #5a6fd8;
        }
        
        /* ===== CONTROL SECTIONS ===== */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .control-group label {
            font-weight: 600;
            color: #555;
            font-size: 14px;
            user-select: none;
        }
        
        .control-group input, 
        .control-group select, 
        .control-group button {
            padding: 10px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .control-group button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .control-group button:hover, 
        .control-group button:focus {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            outline: none;
        }
        
        .control-group input:focus, 
        .control-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        /* ===== CHART CONTAINERS ===== */
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .chart-container:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            border-color: #667eea;
        }
        
        /* Chart maximization overlay */
        .chart-maximize-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            padding: 20px;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .maximize-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }
        
        .maximize-header h3 {
            font-size: 24px;
            font-weight: 300;
        }
        
        .close-maximize {
            background: #ff4757;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-maximize:hover {
            background: #ff3742;
            transform: scale(1.1);
        }
        
        .maximize-chart-wrapper {
            height: calc(100vh - 120px);
            background: white;
            border-radius: 12px;
            padding: 20px;
            position: relative;
        }
        
        /* Trend analysis container */
        .trend-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .trend-container h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 600;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        /* ===== DATA INPUT SECTIONS ===== */
        .data-input {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .data-input h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 600;
        }
        
        .function-input {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .function-input:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .function-input h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        
        /* ===== FORM ELEMENTS ===== */
        .category-header {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: 8px;
        }
        
        .category-header-item {
            text-align: center;
            font-weight: bold;
            font-size: 13px;
            color: #333;
            padding: 6px;
            background: rgba(255,255,255,0.7);
            border-radius: 4px;
        }
        
        .year-data {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .year-label {
            font-weight: 600;
            color: #555;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .grade-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 10px;
        }
        
        .grade-inputs input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .grade-inputs input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            background: #f8f9ff;
        }
        
        /* ===== SIDEBAR SECTIONS ===== */
        .section-header {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 25px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
            position: relative;
        }
        
        .section-header:first-child {
            margin-top: 0;
        }
        
        .section-header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 30px;
            height: 2px;
            background: #764ba2;
        }
        
        /* ===== TEXT STYLING CONTROLS ===== */
        .text-styling-controls {
            background: rgba(102, 126, 234, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }
        
        .text-style-group {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
        }
        
        .text-style-group:last-child {
            margin-bottom: 0;
        }
        
        .text-style-group h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        
        .style-controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        .style-control {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .style-control label {
            font-size: 12px;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .style-control input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }
        
        .style-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .style-control input[type="range"]::-webkit-slider-thumb:hover {
            background: #5a6fd8;
            transform: scale(1.1);
        }
        
        .style-control input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .style-control input[type="color"] {
            width: 50px;
            height: 35px;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .style-control input[type="color"]:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }
        
        .style-control select {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .style-control select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        /* ===== TREND LINE CONTROLS ===== */
        .trendline-controls {
            background: rgba(255, 152, 0, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 152, 0, 0.2);
        }
        
        .trendline-category {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
            transition: all 0.3s ease;
        }
        
        .trendline-category:hover {
            border-color: #ff9800;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.1);
        }
        
        .trendline-category:last-child {
            margin-bottom: 0;
        }
        
        .trendline-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .trendline-color-indicator {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #333;
        }
        
        .trendline-name {
            font-weight: 600;
            color: #333;
            flex: 1;
        }
        
        .trendline-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .trendline-controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        /* ===== DATA LABELS SECTION ===== */
        .data-labels-section {
            background: rgba(76, 175, 80, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 12px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .checkbox-item:hover {
            background: rgba(102, 126, 234, 0.05);
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
            cursor: pointer;
        }
        
        .checkbox-item label {
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
        }
        
        /* ===== SHADING CONTROLS ===== */
        .shading-controls {
            background: rgba(63, 81, 181, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid rgba(63, 81, 181, 0.2);
        }
        
        .shading-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .shading-option:hover {
            background: rgba(63, 81, 181, 0.05);
        }
        
        .shading-option input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
            cursor: pointer;
        }
        
        .shading-option label {
            font-weight: 500;
            cursor: pointer;
            user-select: none;
        }
        
        .shading-preview {
            display: flex;
            gap: 12px;
            margin-top: 15px;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.7);
            border-radius: 6px;
        }
        
        .preview-box {
            width: 50px;
            height: 35px;
            border-radius: 6px;
            border: 2px solid #333;
            transition: all 0.3s ease;
        }
        
        .preview-box:hover {
            transform: scale(1.05);
        }
        
        /* ===== SPACING CONTROLS ===== */
        .spacing-controls {
            background: rgba(255, 193, 7, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }
        
        .spacing-control {
            margin-bottom: 15px;
        }
        
        .spacing-control:last-child {
            margin-bottom: 0;
        }
        
        .spacing-control label {
            display: block;
            font-weight: 600;
            color: #555;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .value-display {
            font-weight: bold;
            color: #667eea;
        }
        
        .spacing-description {
            font-size: 12px;
            color: #666;
            margin-top: 6px;
            font-style: italic;
            line-height: 1.4;
        }
        
        /* ===== ITEM LISTS ===== */
        .add-item {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: end;
            flex-wrap: wrap;
        }
        
        .add-item input, 
        .add-item select {
            flex: 1;
            min-width: 120px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .add-item input:focus, 
        .add-item select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        .add-item button {
            padding: 10px 15px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .add-item button:hover, 
        .add-item button:focus {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
            outline: none;
        }
        
        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 2px solid #eee;
            transition: all 0.3s ease;
        }
        
        .item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        
        .item-color {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            margin-right: 12px;
            border: 2px solid #333;
            transition: all 0.3s ease;
        }
        
        .item-info {
            display: flex;
            align-items: center;
            flex: 1;
            font-weight: 500;
        }
        
        .year-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 2px solid #eee;
            transition: all 0.3s ease;
        }
        
        .year-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        
        .year-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .year-indicator {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .previous-year {
            background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%);
            color: #333;
        }
        
        .current-year {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        /* ===== BUTTONS ===== */
        .remove-button {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }
        
        .remove-button:hover, 
        .remove-button:focus {
            background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
            outline: none;
        }
        
        /* ===== SORTING CONTROLS ===== */
        .sorting-controls {
            margin-bottom: 15px;
        }
        
        .sort-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 2px solid #eee;
            transition: all 0.3s ease;
        }
        
        .sort-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        
        .sort-item span {
            flex: 1;
            font-weight: 500;
        }
        
        .sort-item button {
            padding: 6px 10px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 35px;
        }
        
        .sort-item button:hover:not(:disabled) {
            background: #f0f0f0;
            border-color: #667eea;
            color: #667eea;
        }
        
        .sort-item button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        /* ===== CHART ELEMENTS ===== */
        canvas {
            max-height: 600px;
            transition: all 0.3s ease;
        }
        
        .trend-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .trend-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .trend-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .trend-card h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .trend-card .value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .trend-card .change {
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* ===== LEGEND ===== */
        .legend-custom {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid transparent;
            background: rgba(255,255,255,0.9);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .legend-item:hover {
            border-color: #667eea;
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid #333;
            transition: all 0.3s ease;
        }
        
        .legend-item:hover .legend-color {
            transform: scale(1.1);
        }
        
        /* ===== ACCESSIBILITY ELEMENTS ===== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .skip-link {
            position: absolute;
            top: -50px;
            left: 10px;
            background: #667eea;
            color: white;
            padding: 10px 15px;
            text-decoration: none;
            border-radius: 6px;
            z-index: 10000;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .skip-link:focus {
            top: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        /* Focus indicators for interactive elements */
        [role="region"] {
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 10px;
            transition: all 0.3s ease;
        }
        
        [role="region"]:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        /* ===== LOADING STATES ===== */
        .loading {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            margin: -15px 0 0 -15px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ===== RESPONSIVE DESIGN ===== */
        
        /* Large Desktop Screens (1200px and up) */
        @media (min-width: 1200px) {
            .container {
                max-width: 1800px;
            }
            
            .dashboard {
                grid-template-columns: 1fr 450px;
                gap: 25px;
                padding: 25px;
            }
            
            .header h1 {
                font-size: 32px;
            }
            
            .controls {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        }
        
        /* Medium Desktop Screens (992px to 1199px) */
        @media (max-width: 1199px) and (min-width: 992px) {
            .dashboard {
                grid-template-columns: 1fr 380px;
            }
            
            .controls {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
        }
        
        /* Tablet Landscape (768px to 991px) */
        @media (max-width: 991px) and (min-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .sidebar {
                max-height: none;
                order: -1;
            }
            
            .controls {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 12px;
            }
            
            .text-styling-controls {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 15px;
            }
            
            .trendline-controls {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 15px;
            }
            
            .trend-summary {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        }
        
        /* Tablet Portrait (576px to 767px) */
        @media (max-width: 767px) and (min-width: 576px) {
            body {
                padding: 15px;
            }
            
            .container {
                border-radius: 12px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .header p {
                font-size: 14px;
            }
            
            .dashboard {
                padding: 15px;
                gap: 15px;
            }
            
            .controls {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 10px;
                padding: 15px;
            }
            
            .chart-container,
            .trend-container {
                padding: 20px;
            }
            
            .sidebar {
                padding: 15px;
            }
            
            .text-styling-controls,
            .trendline-controls {
                display: block;
            }
            
            .text-style-group,
            .trendline-category {
                margin-bottom: 15px;
            }
            
            .style-controls {
                grid-template-columns: 1fr;
            }
            
            .trendline-controls-grid {
                grid-template-columns: 1fr;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .trend-summary {
                grid-template-columns: 1fr;
            }
            
            .legend-custom {
                gap: 10px;
            }
            
            .legend-item {
                font-size: 12px;
                padding: 8px 10px;
            }
        }
        
        /* Mobile Devices (up to 575px) */
        @media (max-width: 575px) {
            body {
                padding: 10px;
            }
            
            .container {
                margin: 0;
                border-radius: 8px;
                box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
                letter-spacing: 0.5px;
            }
            
            .header p {
                font-size: 13px;
            }
            
            .dashboard {
                padding: 10px;
                gap: 10px;
            }
            
            .controls {
                grid-template-columns: 1fr;
                gap: 8px;
                padding: 12px;
            }
            
            .control-group {
                gap: 6px;
            }
            
            .control-group input,
            .control-group select,
            .control-group button {
                padding: 8px 10px;
                font-size: 13px;
            }
            
            .chart-container,
            .trend-container,
            .data-input {
                padding: 15px;
            }
            
            .sidebar {
                padding: 12px;
            }
            
            .section-header {
                font-size: 16px;
                margin: 20px 0 12px 0;
            }
            
            .text-style-group,
            .trendline-category {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .style-control input,
            .style-control select {
                padding: 6px;
                font-size: 12px;
            }
            
            .add-item {
                flex-direction: column;
                gap: 8px;
            }
            
            .add-item input,
            .add-item select,
            .add-item button {
                width: 100%;
                min-width: auto;
            }
            
            .item,
            .year-item,
            .sort-item {
                padding: 10px;
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .item-info {
                justify-content: center;
            }
            
            .year-controls,
            .sort-item > div:last-child {
                justify-content: center;
            }
            
            .grade-inputs {
                grid-template-columns: 1fr;
            }
            
            .category-header {
                grid-template-columns: 1fr;
            }
            
            .legend-custom {
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }
            
            .legend-item {
                font-size: 11px;
                padding: 6px 8px;
                width: 100%;
                justify-content: center;
            }
            
            .trend-card {
                padding: 15px;
            }
            
            .trend-card .value {
                font-size: 24px;
            }
            
            .maximize-chart-wrapper {
                padding: 10px;
            }
            
            .close-maximize {
                width: 35px;
                height: 35px;
                font-size: 20px;
            }
        }
        
        /* ===== HIGH CONTRAST MODE ===== */
        @media (prefers-high-contrast: active) {
            .container,
            .function-input,
            .item,
            .year-item,
            .sort-item,
            .chart-container,
            .trend-container {
                border-width: 3px;
                border-color: CanvasText;
            }
            
            .control-group input,
            .control-group select,
            .style-control input,
            .style-control select {
                border-width: 2px;
                border-color: CanvasText;
            }
            
            .legend-color,
            .item-color,
            .preview-box {
                border-width: 3px;
                border-color: CanvasText;
            }
        }
        
        /* ===== REDUCED MOTION ===== */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .chart-maximize-overlay {
                animation: none;
            }
            
            .loading::after {
                animation: none;
            }
        }
        
        /* ===== PRINT STYLES ===== */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                border: 1px solid #000;
            }
            
            .sidebar,
            .controls,
            .skip-link,
            .chart-maximize-overlay {
                display: none !important;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
                padding: 20px;
            }
            
            .chart-container,
            .trend-container {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #000;
            }
            
            .header {
                background: white !important;
                color: black !important;
                border-bottom: 2px solid #000;
            }
            
            canvas {
                max-height: none;
            }
        }
        
        /* ===== DARK MODE SUPPORT ===== */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                color: #e0e0e0;
            }
            
            .container {
                background: #2d3748;
                color: #e0e0e0;
            }
            
            .sidebar,
            .controls,
            .data-input {
                background: #4a5568;
            }
            
            .chart-container,
            .trend-container,
            .function-input,
            .text-style-group,
            .trendline-category,
            .item,
            .year-item,
            .sort-item {
                background: #2d3748;
                border-color: #4a5568;
            }
            
            .control-group input,
            .control-group select,
            .style-control input,
            .style-control select,
            .add-item input,
            .add-item select,
            .grade-inputs input {
                background: #4a5568;
                border-color: #718096;
                color: #e0e0e0;
            }
            
            .category-header {
                background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            }
            
            .category-header-item {
                background: rgba(255,255,255,0.1);
                color: #e0e0e0;
            }
            
            .year-data {
                background: rgba(102, 126, 234, 0.1);
            }
            
            .section-header {
                color: #e0e0e0;
            }
            
            .legend-item {
                background: rgba(45, 55, 72, 0.9);
                color: #e0e0e0;
            }
            
            .legend-item:hover {
                background: #4a5568;
            }
        }
        
        /* ===== ANIMATION KEYFRAMES ===== */
        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        /* Apply animations on load */
        .chart-container,
        .trend-container {
            animation: slideUp 0.6s ease-out;
        }
        
        .sidebar {
            animation: slideIn 0.8s ease-out;
        }
        
        .trend-card:hover {
            animation: pulse 0.6s ease-in-out;
        }
        
        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }
        
        .visible {
            display: block !important;
        }
        
        .fade-in {
            opacity: 0;
            animation: fadeIn 0.5s ease-in-out forwards;
        }
        
        .slide-up {
            animation: slideUp 0.5s ease-out;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-left {
            text-align: left;
        }
        
        .text-right {
            text-align: right;
        }
        
        .mt-10 {
            margin-top: 10px;
        }
        
        .mt-20 {
            margin-top: 20px;
        }
        
        .mb-10 {
            margin-bottom: 10px;
        }
        
        .mb-20 {
            margin-bottom: 20px;
        }
        
        .p-10 {
            padding: 10px;
        }
        
        .p-20 {
            padding: 20px;
        }
        
        /* ===== FOCUS MANAGEMENT ===== */
        .focus-trap {
            position: relative;
        }
        
        .focus-trap:focus-within {
            outline: 3px solid #667eea;
            outline-offset: 2px;
        }
        
        /* ===== CUSTOM SCROLLBARS ===== */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px;
            border: 2px solid #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        
        ::-webkit-scrollbar-corner {
            background: #f1f1f1;
        }
        
        /* ===== END OF CSS STYLES ===== */
    </style>
</head>
<body>
    <!-- Skip navigation link for accessibility - allows keyboard users to jump to main content -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Main container wrapper for the entire dashboard -->
    <div class="container" id="mainContainer">
        
        <!-- Header section with title and description -->
        <header class="header">
            <h1>Enhanced QA Review Analytics Dashboard</h1>
            <p>Fully Customizable Review Analysis with Advanced Styling & Export Options</p>
        </header>
        
        <!-- Main dashboard grid layout container -->
        <div class="dashboard" id="dashboardGrid">
            
            <!-- Main content area containing charts and controls -->
            <main id="main-content" class="main-content">
                
                <!-- Top control bar for basic chart settings -->
                <section class="controls" role="region" aria-label="Chart Controls" tabindex="0">
                    
                    <!-- Chart type selection -->
                    <div class="control-group">
                        <label for="chartType">Chart Type</label>
                        <select id="chartType" aria-describedby="chartType-help">
                            <option value="bar">Stacked Column</option>
                            <option value="horizontalBar">Stacked Bar</option>
                        </select>
                        <div id="chartType-help" class="sr-only">Choose between vertical or horizontal stacked chart display</div>
                    </div>
                    
                    <!-- Animation toggle -->
                    <div class="control-group">
                        <label for="animation">Animation</label>
                        <select id="animation" aria-describedby="animation-help">
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                        <div id="animation-help" class="sr-only">Enable or disable chart animations for better accessibility</div>
                    </div>
                    
                    <!-- Sorting options -->
                    <div class="control-group">
                        <label for="sortBy">Sort By</label>
                        <select id="sortBy" aria-describedby="sortBy-help">
                            <option value="default">Default Order</option>
                            <option value="name">Function Name</option>
                            <option value="totalPrevious">Previous Year Total</option>
                            <option value="totalCurrent">Current Year Total</option>
                            <option value="improvement">Improvement Rate</option>
                            <option value="passRateCurrent">Current Year Pass Rate</option>
                        </select>
                        <div id="sortBy-help" class="sr-only">Choose how to sort functions in the chart</div>
                    </div>
                    
                    <!-- Sort direction -->
                    <div class="control-group">
                        <label for="sortDirection">Sort Direction</label>
                        <select id="sortDirection" aria-describedby="sortDirection-help">
                            <option value="asc">Ascending</option>
                            <option value="desc">Descending</option>
                        </select>
                        <div id="sortDirection-help" class="sr-only">Choose ascending or descending sort order</div>
                    </div>
                    
                    <!-- Quick function addition -->
                    <div class="control-group">
                        <label for="newFunctionName">Add Function</label>
                        <input type="text" id="newFunctionName" placeholder="Function name" aria-describedby="newFunction-help">
                        <div id="newFunction-help" class="sr-only">Enter a new function name to add to the analysis</div>
                    </div>
                    
                    <!-- Add function button -->
                    <div class="control-group">
                        <label>&nbsp;</label>
                        <button onclick="addFunction()" aria-describedby="addFunction-help">Add Function</button>
                        <div id="addFunction-help" class="sr-only">Click to add the new function to the dashboard</div>
                    </div>
                    
                    <!-- Chart view controls -->
                    <div class="control-group">
                        <label for="maximizeChart">Chart View</label>
                        <button id="maximizeChart" onclick="toggleChartMaximize()" aria-describedby="maximize-help">
                            Maximize Chart
                        </button>
                        <div id="maximize-help" class="sr-only">Expand chart to full viewport size</div>
                    </div>
                    
                    <!-- Export functionality -->
                    <div class="control-group">
                        <label for="exportChart">Export</label>
                        <button id="exportChart" onclick="exportChartImage()" aria-describedby="export-help">
                            Take Snapshot
                        </button>
                        <div id="export-help" class="sr-only">Capture chart as image and store in memory</div>
                    </div>
                </section>
                
                <!-- Main chart container with maximize overlay capability -->
                <section class="chart-container" id="chartContainer" role="region" aria-label="Main Chart" tabindex="0">
                    <!-- Chart maximize overlay (hidden by default) -->
                    <div class="chart-maximize-overlay" id="chartMaximizeOverlay" style="display: none;">
                        <div class="maximize-header">
                            <h3>Chart Maximized View</h3>
                            <button class="close-maximize" onclick="toggleChartMaximize()" aria-label="Close maximized view">×</button>
                        </div>
                        <div class="maximize-chart-wrapper">
                            <canvas id="qaChartMaximized" role="img" aria-label="Maximized Quality Assurance Review Results Chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Regular chart canvas -->
                    <canvas id="qaChart" role="img" aria-label="Quality Assurance Review Results Chart"></canvas>
                    
                    <!-- Custom legend container -->
                    <div class="legend-custom" id="legendContainer" role="list" aria-label="Chart Legend"></div>
                </section>
                
                <!-- Trend analysis section -->
                <section class="trend-container" role="region" aria-label="Trend Analysis" tabindex="0">
                    <h3>Trend Analysis</h3>
                    
                    <!-- Summary cards for key metrics -->
                    <div class="trend-summary" id="trendSummary" role="list" aria-label="Trend Summary Cards"></div>
                    
                    <!-- Trend chart canvas -->
                    <canvas id="trendChart" role="img" aria-label="Trend Analysis Chart"></canvas>
                </section>
                
                <!-- Data input form section -->
                <section class="data-input" id="dataInputContainer" role="region" aria-label="Data Input Form" tabindex="0"></section>
            </main>
            
            <!-- Sidebar for configuration options -->
            <aside class="sidebar" role="complementary" aria-label="Configuration Panel">
                
                <!-- Years management section -->
                <div class="section-header">Years Configuration</div>
                <div class="add-item">
                    <input type="text" id="newYearName" placeholder="Year (e.g., 2023)" aria-label="New Year Name">
                    <select id="yearType" aria-label="Year Type">
                        <option value="previous">Previous</option>
                        <option value="current">Current</option>
                    </select>
                    <button onclick="addYear()">Add Year</button>
                </div>
                <div id="yearsList" role="list" aria-label="Years List"></div>
                
                <!-- Chart spacing controls -->
                <div class="section-header">Chart Spacing</div>
                <div class="spacing-controls">
                    <div class="spacing-control">
                        <label for="columnSpacing">Column Spacing: <span class="value-display" id="columnSpacingValue">1</span></label>
                        <input type="range" id="columnSpacing" min="0" max="5" value="1" aria-describedby="columnSpacing-help">
                        <div id="columnSpacing-help" class="spacing-description">Adjust space between year columns within each function</div>
                    </div>
                    <div class="spacing-control">
                        <label for="categoryGap">Category Gap: <span class="value-display" id="categoryGapValue">3</span></label>
                        <input type="range" id="categoryGap" min="1" max="8" value="3" aria-describedby="categoryGap-help">
                        <div id="categoryGap-help" class="spacing-description">Adjust gap between different function categories</div>
                    </div>
                </div>
                
                <!-- Text styling section -->
                <div class="section-header">Text Styling</div>
                <div class="text-styling-controls">
                    <!-- Data labels text styling -->
                    <div class="text-style-group">
                        <h4>Data Labels</h4>
                        <div class="style-controls">
                            <div class="style-control">
                                <label for="dataLabelFontSize">Font Size: <span id="dataLabelFontSizeValue">11px</span></label>
                                <input type="range" id="dataLabelFontSize" min="8" max="20" value="11">
                            </div>
                            <div class="style-control">
                                <label for="dataLabelColor">Color:</label>
                                <input type="color" id="dataLabelColor" value="#333333">
                            </div>
                            <div class="style-control">
                                <label for="dataLabelWeight">Font Weight:</label>
                                <select id="dataLabelWeight">
                                    <option value="normal">Normal</option>
                                    <option value="bold" selected>Bold</option>
                                    <option value="lighter">Light</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Axis labels text styling -->
                    <div class="text-style-group">
                        <h4>Axis Labels</h4>
                        <div class="style-controls">
                            <div class="style-control">
                                <label for="axisLabelFontSize">Font Size: <span id="axisLabelFontSizeValue">12px</span></label>
                                <input type="range" id="axisLabelFontSize" min="8" max="18" value="12">
                            </div>
                            <div class="style-control">
                                <label for="axisLabelColor">Color:</label>
                                <input type="color" id="axisLabelColor" value="#666666">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Function names text styling -->
                    <div class="text-style-group">
                        <h4>Function Names</h4>
                        <div class="style-controls">
                            <div class="style-control">
                                <label for="functionNameFontSize">Font Size: <span id="functionNameFontSizeValue">14px</span></label>
                                <input type="range" id="functionNameFontSize" min="10" max="20" value="14">
                            </div>
                            <div class="style-control">
                                <label for="functionNameColor">Color:</label>
                                <input type="color" id="functionNameColor" value="#333333">
                            </div>
                            <div class="style-control">
                                <label for="functionNameWeight">Font Weight:</label>
                                <select id="functionNameWeight">
                                    <option value="normal">Normal</option>
                                    <option value="bold" selected>Bold</option>
                                    <option value="lighter">Light</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Data labels display options -->
                <div class="section-header">Data Labels</div>
                <div class="data-labels-section">
                    <div class="checkbox-item">
                        <input type="checkbox" id="showDataLabels" checked>
                        <label for="showDataLabels">Show Data Labels</label>
                    </div>
                    <div class="checkbox-group" id="dataLabelOptions">
                        <div class="checkbox-item">
                            <input type="checkbox" id="showValues" checked>
                            <label for="showValues">Values</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="showPercentages">
                            <label for="showPercentages">Percentages</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="showTrendLine" checked>
                            <label for="showTrendLine">Trend Lines</label>
                        </div>
                    </div>
                </div>
                
                <!-- Trend line configuration -->
                <div class="section-header">Trend Line Configuration</div>
                <div class="trendline-controls" id="trendlineControls">
                    <!-- Dynamic trend line controls will be generated here -->
                </div>
                
                <!-- Shading options -->
                <div class="section-header">Shading Options</div>
                <div class="shading-controls">
                    <div class="shading-option">
                        <input type="radio" id="shadingAuto" name="shading" value="auto" checked>
                        <label for="shadingAuto">Auto (Previous=Light, Current=Dark)</label>
                    </div>
                    <div class="shading-option">
                        <input type="radio" id="shadingManual" name="shading" value="manual">
                        <label for="shadingManual">Manual Opacity Control</label>
                    </div>
                    <div id="manualOpacityControls" style="display: none;">
                        <label for="prevOpacity">Previous Year Opacity: <span id="prevOpacityValue">50%</span></label>
                        <input type="range" id="prevOpacity" min="10" max="100" value="50" style="width: 100%;" aria-describedby="prevOpacity-help">
                        <div id="prevOpacity-help" class="sr-only">Adjust opacity for previous year data from 10% to 100%</div>
                        <label for="currOpacity">Current Year Opacity: <span id="currOpacityValue">100%</span></label>
                        <input type="range" id="currOpacity" min="10" max="100" value="100" style="width: 100%;" aria-describedby="currOpacity-help">
                        <div id="currOpacity-help" class="sr-only">Adjust opacity for current year data from 10% to 100%</div>
                    </div>
                    <div class="shading-preview">
                        <span>Preview:</span>
                        <div class="preview-box" id="prevPreview" style="background-color: #4CAF5080;" aria-label="Previous year color preview"></div>
                        <div class="preview-box" id="currPreview" style="background-color: #4CAF50;" aria-label="Current year color preview"></div>
                    </div>
                </div>
                
                <!-- Categories management -->
                <div class="section-header">Categories</div>
                <div class="add-item">
                    <input type="text" id="newCategoryName" placeholder="Category name" aria-label="New Category Name">
                    <input type="color" id="newCategoryColor" value="#2196F3" aria-label="Category Color">
                    <button onclick="addCategory()">Add Category</button>
                </div>
                <div id="categoriesList" role="list" aria-label="Categories List"></div>
                
                <!-- Functions management -->
                <div class="section-header">Functions</div>
                <div class="sorting-controls" id="functionsList" role="list" aria-label="Functions List"></div>
            </aside>
        </div>
    </div>
    
    <!-- Hidden elements for accessibility announcements -->
    <div id="announcement" class="sr-only" aria-live="polite" aria-atomic="true"></div>
    
    <!-- Image storage container for exported charts -->
    <div id="imageStorage" style="display: none;" aria-hidden="true"></div>
    
    <!-- Placeholder for JavaScript - will be provided in Parts 3, 4, and 5 -->
    <script>
            /* ===========================================
           PART 3: CORE JAVASCRIPT VARIABLES & DATA MANAGEMENT
           =========================================== */
        
        // ===== CHART.JS PLUGIN REGISTRATION =====
        // Register the data labels plugin for displaying values on charts
        // With this conditional registration:
        if (typeof ChartDataLabels !== 'undefined') {
            Chart.register(ChartDataLabels);
        } else {
            console.warn('ChartDataLabels plugin not available');
            // Fallback: disable data labels
            const showDataLabelsCheckbox = document.getElementById('showDataLabels');
            if (showDataLabelsCheckbox) {
                showDataLabelsCheckbox.checked = false;
                showDataLabelsCheckbox.disabled = true;
            }
        }
        
        // ===== GLOBAL CHART INSTANCES =====
        // Main chart instance for the primary visualization
        let chart = null;
        // Trend analysis chart instance
        let trendChart = null;
        // Maximized view chart instance (created when user maximizes chart)
        let maximizedChart = null;
        
        // ===== CHART LAYOUT CONFIGURATION =====
        // Controls spacing between year columns within each function group
        let columnSpacing = 1;
        // Controls gap between different function categories
        let categoryGap = 3;
        // Flag to track if chart is currently maximized
        let isChartMaximized = false;
        
        // ===== IMAGE STORAGE FOR EXPORTS =====
        // Array to store exported chart images in memory
        let exportedImages = [];
        // Counter for generating unique image names
        let exportCounter = 1;
        
        // ===== YEARS DATA STRUCTURE =====
        // Array containing year configurations with unique IDs for data mapping
        let years = [
            { 
                name: '2024', 
                type: 'previous', 
                id: 'y2024' 
            },
            { 
                name: '2025', 
                type: 'current', 
                id: 'y2025' 
            }
        ];
        
        // ===== CATEGORIES DATA STRUCTURE =====
        // Array defining the evaluation categories with colors and unique IDs
        let categories = [
            { 
                name: 'Pass', 
                color: '#4CAF50', 
                id: 'pass' 
            },
            { 
                name: 'Needs Improvement', 
                color: '#FF9800', 
                id: 'improvement' 
            },
            { 
                name: 'Substantiation Issues', 
                color: '#F44336', 
                id: 'issues' 
            }
        ];
        
        // ===== FUNCTIONS DATA STRUCTURE =====
        // Array defining the business functions being analyzed
        let functions = [
            { name: 'Treasury', id: 'treasury' },
            { name: 'FC', id: 'fc' },
            { name: 'PC', id: 'pc' },
            { name: 'Tax', id: 'tax' },
            { name: 'CMA', id: 'cma' }
        ];
        
        // ===== TEXT STYLING CONFIGURATION =====
        // Configuration object for all text elements in charts
        let textStyles = {
            // Data labels styling (numbers shown on chart bars)
            dataLabels: {
                fontSize: 11,
                color: '#333333',
                fontWeight: 'bold'
            },
            // Axis labels styling (x and y axis text)
            axisLabels: {
                fontSize: 12,
                color: '#666666',
                fontWeight: 'normal'
            },
            // Function names styling (category headers below chart)
            functionNames: {
                fontSize: 14,
                color: '#333333',
                fontWeight: 'bold'
            },
            // Chart title styling
            title: {
                fontSize: 18,
                color: '#333333',
                fontWeight: 'bold'
            },
            // Legend text styling
            legend: {
                fontSize: 14,
                color: '#333333',
                fontWeight: 'normal'
            }
        };
        
        // ===== TREND LINE CONFIGURATION =====
        // Configuration for each category's trend line display and styling
        let trendLineConfig = {};
        
        // Initialize trend line configurations for each category
        function initializeTrendLineConfig() {
            categories.forEach(category => {
                trendLineConfig[category.id] = {
                    enabled: true,
                    color: category.color,
                    thickness: 2,
                    pointSize: 4,
                    opacity: 1.0,
                    showPoints: true,
                    showLine: true,
                    // Generate complementary color for trend line (darker version of category color)
                    complementaryColor: darkenColor(category.color, 20)
                };
            });
        }
        
        // ===== MAIN DATA STORAGE =====
        // Primary data structure storing all numerical data for functions across years and categories
        let functionData = {};
        
        /**
         * Initialize default data structure for all functions, years, and categories
         * Creates a nested object: functionData[functionId][yearId][categoryIndex] = value
         * @returns {Object} Initialized data structure with default values
         */
        function initializeData() {
            const defaultData = {};
            
            // Iterate through each function
            functions.forEach(func => {
                defaultData[func.id] = {};
                
                // For each function, create entries for all years
                years.forEach(year => {
                    // Initialize array with default values (15, 8, 3) for each category
                    defaultData[func.id][year.id] = [15, 8, 3];
                });
            });
            
            return defaultData;
        }
        
        // ===== DATA ACCESS HELPER FUNCTIONS =====
        
        /**
         * Get the previous year configuration object
         * @returns {Object|null} Previous year object or null if not found
         */
        function getPreviousYear() {
            return years.find(y => y.type === 'previous') || null;
        }
        
        /**
         * Get the current year configuration object
         * @returns {Object|null} Current year object or null if not found
         */
        function getCurrentYear() {
            return years.find(y => y.type === 'current') || null;
        }
        
        /**
         * Get all years of a specific type
         * @param {string} type - 'previous' or 'current'
         * @returns {Array} Array of year objects matching the type
         */
        function getYearsByType(type) {
            return years.filter(y => y.type === type);
        }
        
        /**
         * Find a function by its ID
         * @param {string} functionId - The unique identifier for the function
         * @returns {Object|null} Function object or null if not found
         */
        function getFunctionById(functionId) {
            return functions.find(f => f.id === functionId) || null;
        }
        
        /**
         * Find a category by its ID
         * @param {string} categoryId - The unique identifier for the category
         * @returns {Object|null} Category object or null if not found
         */
        function getCategoryById(categoryId) {
            return categories.find(c => c.id === categoryId) || null;
        }
        
        /**
         * Find a year by its ID
         * @param {string} yearId - The unique identifier for the year
         * @returns {Object|null} Year object or null if not found
         */
        function getYearById(yearId) {
            return years.find(y => y.id === yearId) || null;
        }
        
        // ===== DATA VALIDATION FUNCTIONS =====
        
        /**
         * Validate that a function exists and has data
         * @param {string} functionId - Function ID to validate
         * @returns {boolean} True if function exists and has data
         */
        function validateFunction(functionId) {
            return functionId && 
                   functions.some(f => f.id === functionId) && 
                   functionData[functionId] !== undefined;
        }
        
        /**
         * Validate that a year exists
         * @param {string} yearId - Year ID to validate
         * @returns {boolean} True if year exists
         */
        function validateYear(yearId) {
            return yearId && years.some(y => y.id === yearId);
        }
        
        /**
         * Validate that a category index is within bounds
         * @param {number} categoryIndex - Category index to validate
         * @returns {boolean} True if category index is valid
         */
        function validateCategory(categoryIndex) {
            return typeof categoryIndex === 'number' && 
                   categoryIndex >= 0 && 
                   categoryIndex < categories.length;
        }
        
        // ===== DATA MANIPULATION FUNCTIONS =====
        
        /**
         * Get data value for a specific function, year, and category
         * @param {string} functionId - Function identifier
         * @param {string} yearId - Year identifier  
         * @param {number} categoryIndex - Category index
         * @returns {number} Data value or 0 if not found
         */
        function getDataValue(functionId, yearId, categoryIndex) {
            if (!validateFunction(functionId) || !validateYear(yearId) || !validateCategory(categoryIndex)) {
                return 0;
            }
            
            return functionData[functionId][yearId][categoryIndex] || 0;
        }
        
        /**
         * Set data value for a specific function, year, and category
         * @param {string} functionId - Function identifier
         * @param {string} yearId - Year identifier
         * @param {number} categoryIndex - Category index
         * @param {number} value - Value to set
         * @returns {boolean} True if value was set successfully
         */
        function setDataValue(functionId, yearId, categoryIndex, value) {
            if (!validateFunction(functionId) || !validateYear(yearId) || !validateCategory(categoryIndex)) {
                return false;
            }
            
            // Ensure the data structure exists
            if (!functionData[functionId]) {
                functionData[functionId] = {};
            }
            if (!functionData[functionId][yearId]) {
                functionData[functionId][yearId] = new Array(categories.length).fill(0);
            }
            
            // Set the value (ensure it's a number and non-negative)
            functionData[functionId][yearId][categoryIndex] = Math.max(0, parseInt(value) || 0);
            return true;
        }
        
        /**
         * Get total count for a function in a specific year
         * @param {string} functionId - Function identifier
         * @param {string} yearId - Year identifier
         * @returns {number} Total count across all categories
         */
        function getFunctionYearTotal(functionId, yearId) {
            if (!validateFunction(functionId) || !validateYear(yearId)) {
                return 0;
            }
            
            return functionData[functionId][yearId].reduce((sum, val) => sum + val, 0);
        }
        
        /**
         * Get percentage for a specific category within a function-year combination
         * @param {string} functionId - Function identifier
         * @param {string} yearId - Year identifier
         * @param {number} categoryIndex - Category index
         * @returns {number} Percentage rounded to 2 decimal places
         */
        function getCategoryPercentage(functionId, yearId, categoryIndex) {
            const total = getFunctionYearTotal(functionId, yearId);
            if (total === 0) return 0;
            
            const value = getDataValue(functionId, yearId, categoryIndex);
            return parseFloat(((value / total) * 100).toFixed(2));
        }
        
        /**
         * Calculate year-over-year percentage point change for a category
         * @param {string} functionId - Function identifier
         * @param {number} categoryIndex - Category index
         * @returns {number} Percentage point change rounded to 2 decimal places
         */
        function getYearOverYearChange(functionId, categoryIndex) {
            const prevYear = getPreviousYear();
            const currYear = getCurrentYear();
            
            if (!prevYear || !currYear) return 0;
            
            const prevPercentage = getCategoryPercentage(functionId, prevYear.id, categoryIndex);
            const currPercentage = getCategoryPercentage(functionId, currYear.id, categoryIndex);
            
            return parseFloat((currPercentage - prevPercentage).toFixed(2));
        }
        
        // ===== COLOR UTILITY FUNCTIONS =====
        
        /**
         * Convert hex color to RGB values
         * @param {string} hex - Hex color code (e.g., "#FF0000")
         * @returns {Object} RGB object with r, g, b properties
         */
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
        
        /**
         * Convert RGB values to hex color
         * @param {number} r - Red value (0-255)
         * @param {number} g - Green value (0-255)
         * @param {number} b - Blue value (0-255)
         * @returns {string} Hex color code
         */
        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
        
        /**
         * Darken a hex color by a specified percentage
         * @param {string} hex - Original hex color
         * @param {number} percent - Percentage to darken (0-100)
         * @returns {string} Darkened hex color
         */
        function darkenColor(hex, percent) {
            const rgb = hexToRgb(hex);
            if (!rgb) return hex;
            
            const factor = (100 - percent) / 100;
            const r = Math.round(rgb.r * factor);
            const g = Math.round(rgb.g * factor);
            const b = Math.round(rgb.b * factor);
            
            return rgbToHex(r, g, b);
        }
        
        /**
         * Lighten a hex color by a specified percentage
         * @param {string} hex - Original hex color
         * @param {number} percent - Percentage to lighten (0-100)
         * @returns {string} Lightened hex color
         */
        function lightenColor(hex, percent) {
            const rgb = hexToRgb(hex);
            if (!rgb) return hex;
            
            const factor = percent / 100;
            const r = Math.round(rgb.r + (255 - rgb.r) * factor);
            const g = Math.round(rgb.g + (255 - rgb.g) * factor);
            const b = Math.round(rgb.b + (255 - rgb.b) * factor);
            
            return rgbToHex(r, g, b);
        }
        
        /**
         * Get opacity value based on shading mode and year type
         * @param {string} yearType - 'previous' or 'current'
         * @returns {string} Hex opacity value (00-FF)
         */
        function getOpacity(yearType) {
            const shadingMode = document.querySelector('input[name="shading"]:checked')?.value || 'auto';
            
            if (shadingMode === 'auto') {
                // Auto mode: previous year is lighter (80% opacity), current year is full opacity
                return yearType === 'previous' ? '80' : 'FF';
            } else {
                // Manual mode: get opacity from slider controls
                const prevOpacity = document.getElementById('prevOpacity')?.value || 50;
                const currOpacity = document.getElementById('currOpacity')?.value || 100;
                const opacity = yearType === 'previous' ? prevOpacity : currOpacity;
                
                // Convert percentage to hex (0-255 range)
                return Math.round((opacity / 100) * 255).toString(16).padStart(2, '0');
            }
        }
        
        /**
         * Generate a complementary color palette for trend lines
         * @param {string} baseColor - Base hex color
         * @returns {Object} Object with various color variations
         */
        function generateColorPalette(baseColor) {
            return {
                base: baseColor,
                light: lightenColor(baseColor, 20),
                dark: darkenColor(baseColor, 20),
                veryLight: lightenColor(baseColor, 40),
                veryDark: darkenColor(baseColor, 40)
            };
        }
        
        // ===== CHART CONFIGURATION OBJECTS =====
        
        /**
         * Get default Chart.js configuration for main chart
         * @returns {Object} Chart.js configuration object
         */
        function getDefaultChartConfig() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: document.getElementById('animation')?.value === 'true' ? 750 : 0,
                    easing: 'easeInOutQuart'
                },
                layout: {
                    padding: {
                        top: 40,
                        bottom: 20,
                        left: 10,
                        right: 10
                    }
                },
                plugins: {
                    legend: {
                        display: false // We use custom legend
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#667eea',
                        borderWidth: 2,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            // Custom tooltip formatting will be added in chart creation
                        }
                    },
                    datalabels: {
                        display: false // Controlled separately for each dataset
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: textStyles.axisLabels.color,
                            font: {
                                size: textStyles.axisLabels.fontSize,
                                weight: textStyles.axisLabels.fontWeight
                            },
                            maxRotation: 45,
                            minRotation: 0
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.1)',
                            lineWidth: 1
                        },
                        ticks: {
                            color: textStyles.axisLabels.color,
                            font: {
                                size: textStyles.axisLabels.fontSize,
                                weight: textStyles.axisLabels.fontWeight
                            }
                        },
                        title: {
                            display: true,
                            text: 'Number of Accounts',
                            color: textStyles.title.color,
                            font: {
                                size: textStyles.title.fontSize,
                                weight: textStyles.title.fontWeight
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: false, // Will be enabled when trend lines are shown
                        position: 'right',
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            drawOnChartArea: false
                        },
                        ticks: {
                            color: textStyles.axisLabels.color,
                            font: {
                                size: textStyles.axisLabels.fontSize,
                                weight: textStyles.axisLabels.fontWeight
                            },
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        title: {
                            display: true,
                            text: 'Percentage (%)',
                            color: textStyles.title.color,
                            font: {
                                size: textStyles.title.fontSize,
                                weight: textStyles.title.fontWeight
                            }
                        }
                    }
                }
            };
        }
        
        /**
         * Get default Chart.js configuration for trend chart
         * @returns {Object} Chart.js configuration object for trend analysis
         */
        function getDefaultTrendConfig() {
            return {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: document.getElementById('animation')?.value === 'true' ? 750 : 0,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Year-over-Year Percentage Point Change',
                            color: textStyles.title.color,
                            font: {
                                size: textStyles.title.fontSize,
                                weight: textStyles.title.fontWeight
                            },
                            padding: 20
                        },
                        legend: {
                            display: true,
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                color: textStyles.legend.color,
                                font: {
                                    size: textStyles.legend.fontSize,
                                    weight: textStyles.legend.fontWeight
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#667eea',
                            borderWidth: 2,
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: textStyles.axisLabels.color,
                                font: {
                                    size: textStyles.axisLabels.fontSize,
                                    weight: textStyles.axisLabels.fontWeight
                                }
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                color: textStyles.axisLabels.color,
                                font: {
                                    size: textStyles.axisLabels.fontSize,
                                    weight: textStyles.axisLabels.fontWeight
                                },
                                callback: function(value) {
                                    return value + 'pp';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Percentage Point Change',
                                color: textStyles.title.color,
                                font: {
                                    size: textStyles.title.fontSize,
                                    weight: textStyles.title.fontWeight
                                }
                            }
                        }
                    }
                }
            };
        }
        
        // ===== INITIALIZATION =====
        // Initialize the main data structure with default values
        functionData = initializeData();
        
        // Initialize trend line configurations
        initializeTrendLineConfig();
        
        // ===== DEBUG FUNCTIONS (for development) =====
        
        /**
         * Log current data structure to console (for debugging)
         */
        function debugLogData() {
            console.log('=== Current Data Structure ===');
            console.log('Functions:', functions);
            console.log('Years:', years);
            console.log('Categories:', categories);
            console.log('Function Data:', functionData);
            console.log('Text Styles:', textStyles);
            console.log('Trend Line Config:', trendLineConfig);
        }
        
        /**
         * Validate entire data structure integrity
         * @returns {Object} Validation result with status and any issues found
         */
        function validateDataIntegrity() {
            const issues = [];
            
            // Check if all functions have data for all years
            functions.forEach(func => {
                if (!functionData[func.id]) {
                    issues.push(`Missing data for function: ${func.name}`);
                    return;
                }
                
                years.forEach(year => {
                    if (!functionData[func.id][year.id]) {
                        issues.push(`Missing data for function ${func.name}, year ${year.name}`);
                    } else if (functionData[func.id][year.id].length !== categories.length) {
                        issues.push(`Incorrect data length for function ${func.name}, year ${year.name}`);
                    }
                });
            });
            
            // Check for duplicate IDs
            const functionIds = functions.map(f => f.id);
            const yearIds = years.map(y => y.id);
            const categoryIds = categories.map(c => c.id);
            
            if (new Set(functionIds).size !== functionIds.length) {
                issues.push('Duplicate function IDs detected');
            }
            if (new Set(yearIds).size !== yearIds.length) {
                issues.push('Duplicate year IDs detected');
            }
            if (new Set(categoryIds).size !== categoryIds.length) {
                issues.push('Duplicate category IDs detected');
            }
            
            return {
                valid: issues.length === 0,
                issues: issues
            };
        }
        
        /* ===========================================
           END OF PART 3: CORE JAVASCRIPT VARIABLES & DATA MANAGEMENT
           =========================================== */
        /* ===========================================
           PART 4: UI MANAGEMENT & EVENT HANDLERS
           =========================================== */
        
        // ===== DOM MANIPULATION & RENDERING FUNCTIONS =====
        
        /**
         * Render the years list in the sidebar with add/remove/toggle controls
         * Updates the years configuration section with current year data
         */
        function renderYears() {
            const container = document.getElementById('yearsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            years.forEach((year, index) => {
                const item = document.createElement('div');
                item.className = 'year-item fade-in';
                item.setAttribute('role', 'listitem');
                item.setAttribute('aria-label', `Year ${year.name} configured as ${year.type}`);
                
                item.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-weight: 600; font-size: 16px;">${year.name}</span>
                        <span class="year-indicator ${year.type === 'previous' ? 'previous-year' : 'current-year'}">
                            ${year.type === 'previous' ? 'Previous' : 'Current'}
                        </span>
                    </div>
                    <div class="year-controls">
                        <button onclick="toggleYearType(${index})" 
                                aria-label="Switch ${year.name} to ${year.type === 'previous' ? 'Current' : 'Previous'} year"
                                title="Switch year type">
                            Switch to ${year.type === 'previous' ? 'Current' : 'Previous'}
                        </button>
                        ${years.length > 1 ? `
                            <button class="remove-button" 
                                    onclick="removeYear(${index})" 
                                    aria-label="Remove ${year.name}"
                                    title="Remove this year">
                                Remove
                            </button>
                        ` : ''}
                    </div>
                `;
                container.appendChild(item);
            });
            
            // Update trend line controls after year changes
            renderTrendLineControls();
        }
        
        /**
         * Render the categories list with color indicators and remove buttons
         * Updates the categories section in the sidebar
         */
        function renderCategories() {
            const container = document.getElementById('categoriesList');
            if (!container) return;
            
            container.innerHTML = '';
            
            categories.forEach((category, index) => {
                const item = document.createElement('div');
                item.className = 'item fade-in';
                item.setAttribute('role', 'listitem');
                item.setAttribute('aria-label', `Category ${category.name} with color ${category.color}`);
                
                item.innerHTML = `
                    <div class="item-info">
                        <div class="item-color" 
                             style="background-color: ${category.color}" 
                             aria-label="${category.name} color indicator"
                             title="Category color: ${category.color}"></div>
                        <span style="font-weight: 500;">${category.name}</span>
                    </div>
                    ${categories.length > 1 ? `
                        <button class="remove-button" 
                                onclick="removeCategory(${index})" 
                                aria-label="Remove ${category.name} category"
                                title="Remove this category">
                            Remove
                        </button>
                    ` : ''}
                `;
                container.appendChild(item);
            });
            
            // Update trend line controls when categories change
            renderTrendLineControls();
        }
        
        /**
         * Render the functions list with sorting controls and remove buttons
         * Updates the functions management section in the sidebar
         */
        function renderFunctions() {
            const container = document.getElementById('functionsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            functions.forEach((func, index) => {
                const item = document.createElement('div');
                item.className = 'sort-item fade-in';
                item.setAttribute('role', 'listitem');
                item.setAttribute('aria-label', `Function ${func.name} at position ${index + 1}`);
                
                item.innerHTML = `
                    <span style="font-weight: 500; flex: 1;">${func.name}</span>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="moveFunctionUp(${index})" 
                                ${index === 0 ? 'disabled' : ''} 
                                aria-label="Move ${func.name} up"
                                title="Move up in order">
                            ↑
                        </button>
                        <button onclick="moveFunctionDown(${index})" 
                                ${index === functions.length - 1 ? 'disabled' : ''} 
                                aria-label="Move ${func.name} down"
                                title="Move down in order">
                            ↓
                        </button>
                        ${functions.length > 1 ? `
                            <button class="remove-button" 
                                    onclick="removeFunction(${index})" 
                                    aria-label="Remove ${func.name} function"
                                    title="Remove this function">
                                Remove
                            </button>
                        ` : ''}
                    </div>
                `;
                container.appendChild(item);
            });
        }
        
        /**
         * Render trend line configuration controls for each category
         * Creates individual controls for color, thickness, opacity, etc.
         */
        function renderTrendLineControls() {
            const container = document.getElementById('trendlineControls');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Create header for trend line section
            const header = document.createElement('div');
            header.innerHTML = '<h4 style="margin: 0 0 15px 0; color: #333;">Individual Trend Line Settings</h4>';
            container.appendChild(header);
            
            categories.forEach((category, index) => {
                const config = trendLineConfig[category.id] || {};
                
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'trendline-category fade-in';
                categoryDiv.setAttribute('role', 'group');
                categoryDiv.setAttribute('aria-labelledby', `trendline-${category.id}-title`);
                
                categoryDiv.innerHTML = `
                    <div class="trendline-header">
                        <div class="trendline-color-indicator" 
                             style="background-color: ${category.color};"
                             title="Category color"></div>
                        <span class="trendline-name" id="trendline-${category.id}-title">${category.name}</span>
                        <div class="trendline-toggle">
                            <input type="checkbox" 
                                   id="trendline-${category.id}-enabled" 
                                   ${config.enabled ? 'checked' : ''}
                                   onchange="updateTrendLineConfig('${category.id}', 'enabled', this.checked)"
                                   aria-label="Enable trend line for ${category.name}">
                            <label for="trendline-${category.id}-enabled">Enable</label>
                        </div>
                    </div>
                    
                    <div class="trendline-controls-grid" id="trendline-${category.id}-controls" 
                         style="display: ${config.enabled ? 'grid' : 'none'};">
                        
                        <!-- Color Control -->
                        <div class="style-control">
                            <label for="trendline-${category.id}-color">Color:</label>
                            <input type="color" 
                                   id="trendline-${category.id}-color" 
                                   value="${config.color || category.color}"
                                   onchange="updateTrendLineConfig('${category.id}', 'color', this.value)"
                                   aria-label="Trend line color for ${category.name}">
                        </div>
                        
                        <!-- Thickness Control -->
                        <div class="style-control">
                            <label for="trendline-${category.id}-thickness">
                                Thickness: <span id="trendline-${category.id}-thickness-value">${config.thickness || 2}px</span>
                            </label>
                            <input type="range" 
                                   id="trendline-${category.id}-thickness" 
                                   min="1" max="8" value="${config.thickness || 2}"
                                   oninput="updateTrendLineThickness('${category.id}', this.value)"
                                   onchange="updateTrendLineConfig('${category.id}', 'thickness', parseInt(this.value))"
                                   aria-label="Trend line thickness for ${category.name}">
                        </div>
                        
                        <!-- Point Size Control -->
                        <div class="style-control">
                            <label for="trendline-${category.id}-pointsize">
                                Point Size: <span id="trendline-${category.id}-pointsize-value">${config.pointSize || 4}px</span>
                            </label>
                            <input type="range" 
                                   id="trendline-${category.id}-pointsize" 
                                   min="2" max="10" value="${config.pointSize || 4}"
                                   oninput="updateTrendLinePointSize('${category.id}', this.value)"
                                   onchange="updateTrendLineConfig('${category.id}', 'pointSize', parseInt(this.value))"
                                   aria-label="Trend line point size for ${category.name}">
                        </div>
                        
                        <!-- Opacity Control -->
                        <div class="style-control">
                            <label for="trendline-${category.id}-opacity">
                                Opacity: <span id="trendline-${category.id}-opacity-value">${Math.round((config.opacity || 1) * 100)}%</span>
                            </label>
                            <input type="range" 
                                   id="trendline-${category.id}-opacity" 
                                   min="10" max="100" value="${Math.round((config.opacity || 1) * 100)}"
                                   oninput="updateTrendLineOpacity('${category.id}', this.value)"
                                   onchange="updateTrendLineConfig('${category.id}', 'opacity', this.value / 100)"
                                   aria-label="Trend line opacity for ${category.name}">
                        </div>
                        
                        <!-- Show Points Toggle -->
                        <div class="style-control">
                            <div class="checkbox-item">
                                <input type="checkbox" 
                                       id="trendline-${category.id}-points" 
                                       ${config.showPoints !== false ? 'checked' : ''}
                                       onchange="updateTrendLineConfig('${category.id}', 'showPoints', this.checked)"
                                       aria-label="Show points for ${category.name} trend line">
                                <label for="trendline-${category.id}-points">Show Points</label>
                            </div>
                        </div>
                        
                        <!-- Show Line Toggle -->
                        <div class="style-control">
                            <div class="checkbox-item">
                                <input type="checkbox" 
                                       id="trendline-${category.id}-line" 
                                       ${config.showLine !== false ? 'checked' : ''}
                                       onchange="updateTrendLineConfig('${category.id}', 'showLine', this.checked)"
                                       aria-label="Show line for ${category.name} trend line">
                                <label for="trendline-${category.id}-line">Show Line</label>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(categoryDiv);
            });
        }
        
        /**
         * Render data input forms for all functions with year and category breakdowns
         * Creates the main data entry interface
         */
        function renderDataInput() {
            const container = document.getElementById('dataInputContainer');
            if (!container) return;
            
            container.innerHTML = '<h3>Function Data Entry</h3>';
            
            functions.forEach(func => {
                const funcDiv = document.createElement('div');
                funcDiv.className = 'function-input fade-in';
                funcDiv.setAttribute('role', 'group');
                funcDiv.setAttribute('aria-labelledby', `${func.id}-title`);
                
                // Create category headers
                let categoryHeaders = '';
                categories.forEach(category => {
                    categoryHeaders += `<div class="category-header-item">${category.name}</div>`;
                });
                
                // Create year sections with input fields
                let yearSections = '';
                years.forEach(year => {
                    let categoryInputs = '';
                    categories.forEach((category, catIndex) => {
                        const value = getDataValue(func.id, year.id, catIndex);
                        categoryInputs += `
                            <input type="number" 
                                   id="${func.id}-${year.id}-${category.id}" 
                                   placeholder="${category.name}" 
                                   value="${value}" 
                                   min="0" 
                                   step="1"
                                   onchange="handleDataInput('${func.id}', '${year.id}', ${catIndex}, this.value)"
                                   oninput="validateNumericInput(this)"
                                   aria-label="${category.name} count for ${func.name} in ${year.name}">
                        `;
                    });
                    
                    yearSections += `
                        <div class="year-data">
                            <div class="year-label">${year.name} (${year.type})</div>
                            <div class="grade-inputs">${categoryInputs}</div>
                        </div>
                    `;
                });
                
                funcDiv.innerHTML = `
                    <h3 id="${func.id}-title">${func.name}</h3>
                    <div class="category-header">${categoryHeaders}</div>
                    ${yearSections}
                `;
                
                container.appendChild(funcDiv);
            });
        }
        
        /**
         * Update the legend display with current categories and years
         * Creates simplified legend showing unique categories (not split by year)
         */
        function updateLegend() {
            const container = document.getElementById('legendContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Create simplified legend - one entry per category (not per year)
            categories.forEach((category, index) => {
                const item = document.createElement('div');
                item.className = 'legend-item fade-in';
                item.setAttribute('role', 'listitem');
                item.setAttribute('tabindex', '0');
                item.setAttribute('aria-label', `${category.name} category data`);
                
                item.innerHTML = `
                    <div class="legend-color" 
                         style="background-color: ${category.color};"
                         title="${category.name} color"></div>
                    <span>${category.name}</span>
                `;
                
                container.appendChild(item);
            });
        }
        
        /**
         * Update trend summary cards with calculated metrics
         * Shows key performance indicators in card format
         */
        function updateTrendSummary() {
            const container = document.getElementById('trendSummary');
            if (!container) return;
            
            const prevYear = getPreviousYear();
            const currYear = getCurrentYear();
            
            if (!prevYear || !currYear) {
                container.innerHTML = '<p>Please configure both previous and current years to see trend analysis.</p>';
                return;
            }
            
            // Calculate aggregate metrics across all functions
            let totalAccountsPrev = 0;
            let totalAccountsCurr = 0;
            let totalPassPrev = 0;
            let totalPassCurr = 0;
            let totalIssuesPrev = 0;
            let totalIssuesCurr = 0;
            
            functions.forEach(func => {
                const accountsPrev = getFunctionYearTotal(func.id, prevYear.id);
                const accountsCurr = getFunctionYearTotal(func.id, currYear.id);
                const passPrev = getDataValue(func.id, prevYear.id, 0); // First category is typically "Pass"
                const passCurr = getDataValue(func.id, currYear.id, 0);
                const issuesPrev = getDataValue(func.id, prevYear.id, categories.length - 1); // Last category is typically "Issues"
                const issuesCurr = getDataValue(func.id, currYear.id, categories.length - 1);
                
                totalAccountsPrev += accountsPrev;
                totalAccountsCurr += accountsCurr;
                totalPassPrev += passPrev;
                totalPassCurr += passCurr;
                totalIssuesPrev += issuesPrev;
                totalIssuesCurr += issuesCurr;
            });
            
            // Calculate rates and changes
            const passRatePrev = totalAccountsPrev > 0 ? (totalPassPrev / totalAccountsPrev) * 100 : 0;
            const passRateCurr = totalAccountsCurr > 0 ? (totalPassCurr / totalAccountsCurr) * 100 : 0;
            const issueRatePrev = totalAccountsPrev > 0 ? (totalIssuesPrev / totalAccountsPrev) * 100 : 0;
            const issueRateCurr = totalAccountsCurr > 0 ? (totalIssuesCurr / totalAccountsCurr) * 100 : 0;
            
            const passRateChange = passRateCurr - passRatePrev;
            const issueRateChange = issueRateCurr - issueRatePrev;
            const volumeChange = totalAccountsCurr - totalAccountsPrev;
            
            // Create summary cards
            const cards = [
                {
                    title: `Overall Pass Rate ${currYear.name}`,
                    value: `${passRateCurr.toFixed(1)}%`,
                    change: `${passRateChange >= 0 ? '+' : ''}${passRateChange.toFixed(1)}pp vs ${prevYear.name}`
                },
                {
                    title: `Issue Rate ${currYear.name}`,
                    value: `${issueRateCurr.toFixed(1)}%`,
                    change: `${issueRateChange >= 0 ? '+' : ''}${issueRateChange.toFixed(1)}pp vs ${prevYear.name}`
                },
                {
                    title: `Total Reviews ${currYear.name}`,
                    value: totalAccountsCurr.toString(),
                    change: `${volumeChange >= 0 ? '+' : ''}${volumeChange} vs ${prevYear.name}`
                },
                {
                    title: 'Best Performing',
                    value: getBestPerformingFunction(),
                    change: `Highest ${currYear.name} pass rate`
                }
            ];
            
            container.innerHTML = '';
            cards.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'trend-card fade-in';
                cardEl.style.animationDelay = `${index * 0.1}s`;
                cardEl.setAttribute('role', 'listitem');
                cardEl.setAttribute('tabindex', '0');
                cardEl.setAttribute('aria-label', `${card.title}: ${card.value}, ${card.change}`);
                
                cardEl.innerHTML = `
                    <h4>${card.title}</h4>
                    <div class="value">${card.value}</div>
                    <div class="change">${card.change}</div>
                `;
                container.appendChild(cardEl);
            });
        }
        
        /**
         * Get the best performing function based on current year pass rate
         * @returns {string} Name of the best performing function
         */
        function getBestPerformingFunction() {
            const currYear = getCurrentYear();
            if (!currYear) return 'N/A';
            
            let bestFunction = '';
            let bestRate = 0;
            
            functions.forEach(func => {
                const passRate = getCategoryPercentage(func.id, currYear.id, 0); // First category is typically "Pass"
                
                if (passRate > bestRate) {
                    bestRate = passRate;
                    bestFunction = func.name;
                }
            });
            
            return bestFunction || 'N/A';
        }
        
        // ===== EVENT HANDLERS FOR DATA MANIPULATION =====
        
        /**
         * Handle data input changes from form fields
         * @param {string} functionId - Function identifier
         * @param {string} yearId - Year identifier
         * @param {number} categoryIndex - Category index
         * @param {string} value - Input value from form field
         */
        function handleDataInput(functionId, yearId, categoryIndex, value) {
            const numValue = parseInt(value) || 0;
            setDataValue(functionId, yearId, categoryIndex, numValue);
            
            // Clear existing timeout
            if (updateTimeout) {
                clearTimeout(updateTimeout);
            }
            
            // Throttle chart updates
            updateTimeout = setTimeout(() => {
                createCharts();
                announceChange(`Updated ${getCategoryById(categories[categoryIndex].id)?.name || 'data'} for ${getFunctionById(functionId)?.name || 'function'}`);
            }, 300); // Wait 300ms after last input
        }
        
        /**
         * Validate numeric input fields to ensure only positive integers
         * @param {HTMLInputElement} input - Input element to validate
         */
        function validateNumericInput(input) {
            let value = input.value;
            
            // Remove any non-numeric characters except decimal point
            value = value.replace(/[^\d]/g, '');
            
            // Ensure value is not negative
            if (parseInt(value) < 0) {
                value = '0';
            }
            
            input.value = value;
        }
        
        /**
         * Add a new year to the configuration
         */
        function addYear() {
            const nameInput = document.getElementById('newYearName');
            const typeSelect = document.getElementById('yearType');
            
            if (!nameInput || !typeSelect) return;
            
            const name = nameInput.value.trim();
            const type = typeSelect.value;
            
            if (!name) {
                announceChange('Please enter a year name');
                nameInput.focus();
                return;
            }
            
            // Check for duplicate year names
            if (years.some(y => y.name === name)) {
                announceChange('Year name already exists');
                nameInput.focus();
                return;
            }
            
            // If adding a year of existing type, change the existing one to the opposite type
            const existingType = years.find(y => y.type === type);
            if (existingType) {
                existingType.type = type === 'previous' ? 'current' : 'previous';
            }
            
            // Create new year with unique ID
            const id = 'y' + name.replace(/\s+/g, '');
            const newYear = { name, type, id };
            years.push(newYear);
            
            // Initialize data for new year across all functions
            functions.forEach(func => {
                if (!functionData[func.id]) functionData[func.id] = {};
                functionData[func.id][id] = new Array(categories.length).fill(0);
            });
            
            // Clear input and update UI
            nameInput.value = '';
            renderYears();
            renderDataInput();
            createCharts();
            announceChange(`Added ${name} as ${type} year`);
        }
        
        /**
         * Remove a year from the configuration
         * @param {number} index - Index of year to remove
         */
        function removeYear(index) {
            if (years.length <= 1) {
                announceChange('Cannot remove the last year');
                return;
            }
            
            const year = years[index];
            
            // Remove data for this year from all functions
            functions.forEach(func => {
                if (functionData[func.id]) {
                    delete functionData[func.id][year.id];
                }
            });
            
            // Remove year from array
            years.splice(index, 1);
            
            renderYears();
            renderDataInput();
            createCharts();
            announceChange(`Removed ${year.name}`);
        }
        
        /**
         * Toggle year type between previous and current
         * @param {number} index - Index of year to toggle
         */
        function toggleYearType(index) {
            const year = years[index];
            const newType = year.type === 'previous' ? 'current' : 'previous';
            
            // If changing to a type that already exists, swap them
            const existingTypeIndex = years.findIndex(y => y.type === newType);
            if (existingTypeIndex !== -1 && existingTypeIndex !== index) {
                years[existingTypeIndex].type = year.type;
            }
            
            year.type = newType;
            
            renderYears();
            renderDataInput();
            createCharts();
            announceChange(`Changed ${year.name} to ${newType} year`);
        }
        
        /**
         * Add a new category to the configuration
         */
        function addCategory() {
            const nameInput = document.getElementById('newCategoryName');
            const colorInput = document.getElementById('newCategoryColor');
            
            if (!nameInput || !colorInput) return;
            
            const name = nameInput.value.trim();
            const color = colorInput.value;
            
            if (!name) {
                announceChange('Please enter a category name');
                nameInput.focus();
                return;
            }
            
            // Check for duplicate category names
            if (categories.some(c => c.name === name)) {
                announceChange('Category name already exists');
                nameInput.focus();
                return;
            }
            
            // Create new category with unique ID
            const id = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
            const newCategory = { name, color, id };
            categories.push(newCategory);
            
            // Add new category data to all functions and years
            functions.forEach(func => {
                years.forEach(year => {
                    if (!functionData[func.id]) functionData[func.id] = {};
                    if (!functionData[func.id][year.id]) functionData[func.id][year.id] = [];
                    functionData[func.id][year.id].push(0);
                });
            });
            
            // Initialize trend line configuration for new category
            trendLineConfig[id] = {
                enabled: true,
                color: color,
                thickness: 2,
                pointSize: 4,
                opacity: 1.0,
                showPoints: true,
                showLine: true,
                complementaryColor: darkenColor(color, 20)
            };
            
            // Clear input and update UI
            nameInput.value = '';
            colorInput.value = '#2196F3';
            renderCategories();
            renderDataInput();
            renderTrendLineControls();
            createCharts();
            announceChange(`Added ${name} category`);
        }
        
        /**
         * Remove a category from the configuration
         * @param {number} index - Index of category to remove
         */
        function removeCategory(index) {
            if (categories.length <= 1) {
                announceChange('Cannot remove the last category');
                return;
            }
            
            const category = categories[index];
            
            // Remove category data from all functions and years
            functions.forEach(func => {
                years.forEach(year => {
                    if (functionData[func.id] && functionData[func.id][year.id]) {
                        functionData[func.id][year.id].splice(index, 1);
                    }
                });
            });
            
            // Remove trend line configuration
            delete trendLineConfig[category.id];
            
            // Remove category from array
            categories.splice(index, 1);
            
            renderCategories();
            renderDataInput();
            renderTrendLineControls();
            createCharts();
            announceChange(`Removed ${category.name} category`);
        }
        
        /**
         * Add a new function to the configuration
         */
        function addFunction() {
            const nameInput = document.getElementById('newFunctionName');
            
            if (!nameInput) return;
            
            const name = nameInput.value.trim();
            
            if (!name) {
                announceChange('Please enter a function name');
                nameInput.focus();
                return;
            }
            
            // Check for duplicate function names
            if (functions.some(f => f.name === name)) {
                announceChange('Function name already exists');
                nameInput.focus();
                return;
            }
            
            // Create new function with unique ID
            const id = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
            const newFunction = { name, id };
            functions.push(newFunction);
            
            // Initialize data for new function across all years
            functionData[id] = {};
            years.forEach(year => {
                functionData[id][year.id] = new Array(categories.length).fill(0);
            });
            
            // Clear input and update UI
            nameInput.value = '';
            renderFunctions();
            renderDataInput();
            createCharts();
            announceChange(`Added ${name} function`);
        }
        
        /**
         * Remove a function from the configuration
         * @param {number} index - Index of function to remove
         */
        function removeFunction(index) {
            if (functions.length <= 1) {
                announceChange('Cannot remove the last function');
                return;
            }
            
            const func = functions[index];
            
            // Remove function data
            delete functionData[func.id];
            
            // Remove function from array
            functions.splice(index, 1);
            
            renderFunctions();
            renderDataInput();
            createCharts();
            announceChange(`Removed ${func.name} function`);
        }
        
        /**
         * Move function up in the order
         * @param {number} index - Current index of function
         */
        function moveFunctionUp(index) {
            if (index > 0) {
                [functions[index], functions[index - 1]] = [functions[index - 1], functions[index]];
                renderFunctions();
                createCharts();
                announceChange(`Moved ${functions[index - 1].name} up`);
            }
        }
        
        /**
         * Move function down in the order
         * @param {number} index - Current index of function
         */
        function moveFunctionDown(index) {
            if (index < functions.length - 1) {
                [functions[index], functions[index + 1]] = [functions[index + 1], functions[index]];
                renderFunctions();
                createCharts();
                announceChange(`Moved ${functions[index + 1].name} down`);
            }
        }
        
        // ===== TEXT STYLING EVENT HANDLERS =====
        /**
         * Update text style configuration and refresh charts
         * @param {string} element - Text element type (dataLabels, axisLabels, etc.)
         * @param {string} property - Style property (fontSize, color, fontWeight)
         * @param {*} value - New value for the property
         */
        function updateTextStyle(element, property, value) {
            if (!textStyles[element]) {
                textStyles[element] = {};
            }
            
            textStyles[element][property] = value;
            
            // Update display values for range sliders
            updateTextStyleDisplays();
            
            // Recreate charts with new styling
            createCharts();
        }
        
        /**
         * Update display values for text style range sliders
         */
        function updateTextStyleDisplays() {
            // Data Labels
            const dataLabelSizeEl = document.getElementById('dataLabelFontSizeValue');
            if (dataLabelSizeEl) {
                dataLabelSizeEl.textContent = textStyles.dataLabels.fontSize + 'px';
            }
            
            // Axis Labels
            const axisLabelSizeEl = document.getElementById('axisLabelFontSizeValue');
            if (axisLabelSizeEl) {
                axisLabelSizeEl.textContent = textStyles.axisLabels.fontSize + 'px';
            }
            
            // Function Names
            const functionNameSizeEl = document.getElementById('functionNameFontSizeValue');
            if (functionNameSizeEl) {
                functionNameSizeEl.textContent = textStyles.functionNames.fontSize + 'px';
            }
        }
        
        // ===== TREND LINE CONFIGURATION HANDLERS =====
        
        /**
         * Update trend line configuration for a specific category
         * @param {string} categoryId - Category identifier
         * @param {string} property - Property to update
         * @param {*} value - New value
         */
        function updateTrendLineConfig(categoryId, property, value) {
            if (!trendLineConfig[categoryId]) {
                trendLineConfig[categoryId] = {};
            }
            
            trendLineConfig[categoryId][property] = value;
            
            // Toggle controls visibility when enabled/disabled
            if (property === 'enabled') {
                const controlsEl = document.getElementById(`trendline-${categoryId}-controls`);
                if (controlsEl) {
                    controlsEl.style.display = value ? 'grid' : 'none';
                }
            }
            
            // Recreate charts with new trend line configuration
            createCharts();
        }
        
        /**
         * Update trend line thickness display and configuration
         * @param {string} categoryId - Category identifier
         * @param {string} value - Thickness value
         */
        function updateTrendLineThickness(categoryId, value) {
            const displayEl = document.getElementById(`trendline-${categoryId}-thickness-value`);
            if (displayEl) {
                displayEl.textContent = value + 'px';
            }
        }
        
        /**
         * Update trend line point size display and configuration
         * @param {string} categoryId - Category identifier
         * @param {string} value - Point size value
         */
        function updateTrendLinePointSize(categoryId, value) {
            const displayEl = document.getElementById(`trendline-${categoryId}-pointsize-value`);
            if (displayEl) {
                displayEl.textContent = value + 'px';
            }
        }
        
        /**
         * Update trend line opacity display and configuration
         * @param {string} categoryId - Category identifier
         * @param {string} value - Opacity value (0-100)
         */
        function updateTrendLineOpacity(categoryId, value) {
            const displayEl = document.getElementById(`trendline-${categoryId}-opacity-value`);
            if (displayEl) {
                displayEl.textContent = value + '%';
            }
        }
        
        // ===== CHART MAXIMIZATION HANDLERS =====
        
        /**
         * Toggle chart between normal and maximized view
         */
        function toggleChartMaximize() {
            const overlay = document.getElementById('chartMaximizeOverlay');
            const button = document.getElementById('maximizeChart');
            
            if (!overlay || !button) return;
            
            isChartMaximized = !isChartMaximized;
            
            if (isChartMaximized) {
                // Show maximized view
                overlay.style.display = 'block';
                button.textContent = 'Minimize Chart';
                button.setAttribute('aria-label', 'Minimize chart to normal view');
                
                // Create maximized chart
                setTimeout(() => {
                    createMaximizedChart();
                }, 100);
                
                // Trap focus within overlay
                trapFocus(overlay);
                
                announceChange('Chart maximized to full screen');
            } else {
                // Hide maximized view
                overlay.style.display = 'none';
                button.textContent = 'Maximize Chart';
                button.setAttribute('aria-label', 'Expand chart to full viewport size');
                
                // Destroy maximized chart
                if (maximizedChart) {
                    maximizedChart.destroy();
                    maximizedChart = null;
                }
                
                announceChange('Chart minimized to normal view');
            }
        }
        
        /**
         * Trap focus within a container element
         * @param {HTMLElement} container - Container to trap focus within
         */
        function trapFocus(container) {
            const focusableElements = container.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];
            
            if (firstElement) firstElement.focus();
            
            container.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    if (e.shiftKey) {
                        if (document.activeElement === firstElement) {
                            e.preventDefault();
                            lastElement.focus();
                        }
                    } else {
                        if (document.activeElement === lastElement) {
                            e.preventDefault();
                            firstElement.focus();
                        }
                    }
                }
                
                if (e.key === 'Escape') {
                    toggleChartMaximize();
                }
            });
        }
        
        // ===== EXPORT FUNCTIONALITY =====
        
        /**
         * Export current chart as image and store in memory
         */
        function exportChartImage() {
            const canvas = document.getElementById('qaChart');
            if (!canvas || !chart) {
                announceChange('No chart available to export');
                return;
            }
            
            try {
                // Create high-quality image data
                const imageData = canvas.toDataURL('image/png', 1.0);
                
                // Generate unique filename
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                const filename = `chart_export_${exportCounter}_${timestamp}.png`;
                
                // Store in memory
                const exportedImage = {
                    id: exportCounter,
                    filename: filename,
                    dataUrl: imageData,
                    timestamp: new Date(),
                    chartType: document.getElementById('chartType')?.value || 'bar',
                    functionsCount: functions.length,
                    categoriesCount: categories.length
                };
                
                exportedImages.push(exportedImage);
                // Memory management: keep only last 10 exports
                if (exportedImages.length > 10) {
                    exportedImages.shift(); // Remove oldest export
                }
                exportCounter++;
                
                // Create a temporary download element to show the image was captured
                createImagePreview(exportedImage);
                
                announceChange(`Chart exported as ${filename} and stored in memory`);
                
            } catch (error) {
                console.error('Export failed:', error);
                announceChange('Failed to export chart. Please try again.');
            }
        }
        
        /**
         * Create a preview of the exported image
         * @param {Object} exportedImage - Exported image data
         */
        function createImagePreview(exportedImage) {
            const storageContainer = document.getElementById('imageStorage');
            if (!storageContainer) return;
            
            const preview = document.createElement('div');
            preview.className = 'image-preview fade-in';
            preview.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                border: 2px solid #667eea;
                border-radius: 8px;
                padding: 15px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 1000;
                max-width: 300px;
            `;
            
            preview.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong>Image Exported</strong>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: #f44336; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;"
                            aria-label="Close preview">×</button>
                </div>
                <img src="${exportedImage.dataUrl}" 
                     style="width: 100%; height: auto; border-radius: 4px; margin-bottom: 10px;"
                     alt="Exported chart preview">
                <div style="font-size: 12px; color: #666;">
                    <div>Filename: ${exportedImage.filename}</div>
                    <div>Stored in memory (ID: ${exportedImage.id})</div>
                </div>
            `;
            
            document.body.appendChild(preview);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (preview.parentElement) {
                    preview.remove();
                }
            }, 5000);
        }
        
        // ===== UTILITY FUNCTIONS =====
        
        /**
         * Update shading preview boxes when opacity settings change
         */
        function updateShadingPreview() {
            const prevPreview = document.getElementById('prevPreview');
            const currPreview = document.getElementById('currPreview');
            
            if (prevPreview && currPreview) {
                const prevOpacity = getOpacity('previous');
                const currOpacity = getOpacity('current');
                
                // Use first category color for preview
                const baseColor = categories[0]?.color || '#4CAF50';
                
                prevPreview.style.backgroundColor = baseColor + prevOpacity;
                currPreview.style.backgroundColor = baseColor + currOpacity;
            }
        }
        
        /**
         * Update chart spacing and recreate charts
         */
        function updateSpacing() {
            const columnSpacingEl = document.getElementById('columnSpacing');
            const categoryGapEl = document.getElementById('categoryGap');
            
            if (columnSpacingEl) {
                columnSpacing = parseInt(columnSpacingEl.value);
                document.getElementById('columnSpacingValue').textContent = columnSpacing;
            }
            
            if (categoryGapEl) {
                categoryGap = parseInt(categoryGapEl.value);
                document.getElementById('categoryGapValue').textContent = categoryGap;
            }
            
            createCharts();
        }
        
        /**
         * Toggle data label options visibility
         */
        function toggleDataLabelOptions() {
            const showDataLabels = document.getElementById('showDataLabels')?.checked || false;
            const options = document.getElementById('dataLabelOptions');
            
            if (options) {
                options.style.display = showDataLabels ? 'grid' : 'none';
                options.setAttribute('aria-hidden', showDataLabels ? 'false' : 'true');
            }
        }
        
        /**
         * Announce changes to screen readers
         * @param {string} message - Message to announce
         */
        function announceChange(message) {
            const announcement = document.getElementById('announcement');
            if (announcement) {
                announcement.textContent = message;
                
                // Clear after a delay to allow for multiple announcements
                setTimeout(() => {
                    announcement.textContent = '';
                }, 1000);
            }
        }
        
        /**
         * Get sorted functions based on current sort settings
         * @returns {Array} Sorted array of functions
         */
        function getSortedFunctions() {
            const sortBy = document.getElementById('sortBy')?.value || 'default';
            const sortDirection = document.getElementById('sortDirection')?.value || 'asc';
            
            let sortedFunctions = [...functions];
            const prevYear = getPreviousYear();
            const currYear = getCurrentYear();
            
            if (!prevYear || !currYear) return sortedFunctions;
            
            switch (sortBy) {
                case 'name':
                    sortedFunctions.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                    
                case 'totalPrevious':
                    sortedFunctions.sort((a, b) => {
                        const totalA = getFunctionYearTotal(a.id, prevYear.id);
                        const totalB = getFunctionYearTotal(b.id, prevYear.id);
                        return totalA - totalB;
                    });
                    break;
                    
                case 'totalCurrent':
                    sortedFunctions.sort((a, b) => {
                        const totalA = getFunctionYearTotal(a.id, currYear.id);
                        const totalB = getFunctionYearTotal(b.id, currYear.id);
                        return totalA - totalB;
                    });
                    break;
                    
                case 'improvement':
                    sortedFunctions.sort((a, b) => {
                        const improvementA = getYearOverYearChange(a.id, 0); // Use first category for improvement
                        const improvementB = getYearOverYearChange(b.id, 0);
                        return improvementA - improvementB;
                    });
                    break;
                    
                case 'passRateCurrent':
                    sortedFunctions.sort((a, b) => {
                        const passRateA = getCategoryPercentage(a.id, currYear.id, 0);
                        const passRateB = getCategoryPercentage(b.id, currYear.id, 0);
                        return passRateA - passRateB;
                    });
                    break;
                    
                default:
                    // Keep original order
                    break;
            }
            
            if (sortDirection === 'desc') {
                sortedFunctions.reverse();
            }
            
            return sortedFunctions;
        }
        
        // ===== EVENT LISTENER SETUP =====
        
        /**
         * Initialize all event listeners for the application
         */
        function initializeEventListeners() {
            // Text styling controls
            document.addEventListener('input', function(e) {
                // Data label font size
                if (e.target.id === 'dataLabelFontSize') {
                    updateTextStyle('dataLabels', 'fontSize', parseInt(e.target.value));
                }
                // Axis label font size
                else if (e.target.id === 'axisLabelFontSize') {
                    updateTextStyle('axisLabels', 'fontSize', parseInt(e.target.value));
                }
                // Function name font size
                else if (e.target.id === 'functionNameFontSize') {
                    updateTextStyle('functionNames', 'fontSize', parseInt(e.target.value));
                }
                // Opacity controls
                else if (e.target.id === 'prevOpacity' || e.target.id === 'currOpacity') {
                    const isPrevoius = e.target.id === 'prevOpacity';
                    const valueEl = document.getElementById(isPrevoius ? 'prevOpacityValue' : 'currOpacityValue');
                    if (valueEl) valueEl.textContent = e.target.value + '%';
                    updateShadingPreview();
                }
                // Chart spacing controls
                else if (e.target.id === 'columnSpacing' || e.target.id === 'categoryGap') {
                    updateSpacing();
                }
                // Data input fields
                else if (e.target.type === 'number' && e.target.id.includes('-')) {
                    // Real-time validation for numeric inputs
                    validateNumericInput(e.target);
                }
            });
            
            // Color and select changes
            document.addEventListener('change', function(e) {
                // Text styling colors
                if (e.target.id === 'dataLabelColor') {
                    updateTextStyle('dataLabels', 'color', e.target.value);
                }
                else if (e.target.id === 'axisLabelColor') {
                    updateTextStyle('axisLabels', 'color', e.target.value);
                }
                else if (e.target.id === 'functionNameColor') {
                    updateTextStyle('functionNames', 'color', e.target.value);
                }
                // Text styling weights
                else if (e.target.id === 'dataLabelWeight') {
                    updateTextStyle('dataLabels', 'fontWeight', e.target.value);
                }
                else if (e.target.id === 'functionNameWeight') {
                    updateTextStyle('functionNames', 'fontWeight', e.target.value);
                }
                // Chart controls
                else if (['chartType', 'animation', 'sortBy', 'sortDirection'].includes(e.target.id)) {
                    createCharts();
                }
                // Data label checkboxes
                else if (['showDataLabels', 'showValues', 'showPercentages', 'showTrendLine'].includes(e.target.id)) {
                    if (e.target.id === 'showDataLabels') {
                        toggleDataLabelOptions();
                    }
                    createCharts();
                }
                // Shading controls
                else if (e.target.name === 'shading') {
                    const manualControls = document.getElementById('manualOpacityControls');
                    if (manualControls) {
                        manualControls.style.display = e.target.value === 'manual' ? 'block' : 'none';
                    }
                    updateShadingPreview();
                    createCharts();
                }
                // Opacity changes
                else if (e.target.id === 'prevOpacity' || e.target.id === 'currOpacity') {
                    updateShadingPreview();
                    createCharts();
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Enter key for adding items
                if (e.key === 'Enter') {
                    if (e.target.id === 'newCategoryName') {
                        addCategory();
                    } else if (e.target.id === 'newFunctionName') {
                        addFunction();
                    } else if (e.target.id === 'newYearName') {
                        addYear();
                    }
                }
                // Escape key to close maximized view
                else if (e.key === 'Escape' && isChartMaximized) {
                    toggleChartMaximize();
                }
                // Ctrl+E for export
                else if (e.ctrlKey && e.key === 'e') {
                    e.preventDefault();
                    exportChartImage();
                }
                // Ctrl+M for maximize/minimize
                else if (e.ctrlKey && e.key === 'm') {
                    e.preventDefault();
                    toggleChartMaximize();
                }
            });
            
            // Focus management for accessibility
            document.addEventListener('focusin', function(e) {
                if (e.target.matches('.function-input')) {
                    e.target.style.borderColor = '#667eea';
                }
            });
            
            document.addEventListener('focusout', function(e) {
                if (e.target.matches('.function-input')) {
                    e.target.style.borderColor = 'transparent';
                }
            });
            
            // Window resize handling for responsive behavior
            window.addEventListener('resize', debounce(function() {
                if (chart) {
                    chart.resize();
                }
                if (trendChart) {
                    trendChart.resize();
                }
                if (maximizedChart) {
                    maximizedChart.resize();
                }
            }, 250));
        }
        
        /**
         * Debounce function to limit how often a function can be called
         * @param {Function} func - Function to debounce
         * @param {number} wait - Wait time in milliseconds
         * @returns {Function} Debounced function
         */
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        /* ===========================================
           END OF PART 4: UI MANAGEMENT & EVENT HANDLERS
           =========================================== */
       /* ===========================================
           PART 5: CHART CREATION & ADVANCED FEATURES
           =========================================== */
        
        // ===== MAIN CHART CREATION FUNCTIONS =====
        
        /**
         * Create the main stacked bar/column chart with trend lines
         * Handles all chart configuration, data preparation, and rendering
         */
        function createMainChart() {
            const ctx = document.getElementById('qaChart').getContext('2d');
            const sortedFunctions = getSortedFunctions();
            const prevYear = getPreviousYear();
            const currYear = getCurrentYear();
            
            if (!prevYear || !currYear) {
                console.warn('Cannot create chart: Missing year configuration');
                return;
            }
            
            // Generate dynamic labels with spacing controls
            const labels = generateChartLabels(sortedFunctions);
            
            // Get display options from UI controls
            const showDataLabels = document.getElementById('showDataLabels')?.checked || false;
            const showValues = document.getElementById('showValues')?.checked || false;
            const showPercentages = document.getElementById('showPercentages')?.checked || false;
            const showTrendLine = document.getElementById('showTrendLine')?.checked || false;
            const chartType = document.getElementById('chartType')?.value || 'bar';
            const animation = document.getElementById('animation')?.value === 'true';
            
            // Generate datasets for bars and trend lines
            const datasets = generateChartDatasets(
                sortedFunctions, 
                labels, 
                showDataLabels, 
                showValues, 
                showPercentages, 
                showTrendLine
            );
            
            // Create chart configuration
            const config = {
                type: chartType,
                data: { labels, datasets },
                options: createMainChartOptions(chartType, animation, showTrendLine, prevYear, currYear),
                plugins: [createFunctionNamePlugin(sortedFunctions, labels)]
            };
            
            // Destroy existing chart and create new one
            if (chart) {
                chart.destroy();
            }
            chart = new Chart(ctx, config);
            
            // Update supporting elements
            updateLegend();
            updateChartAccessibility();
        }
        
        /**
         * Generate chart labels with proper spacing
         * @param {Array} sortedFunctions - Array of sorted function objects
         * @returns {Array} Array of labels with spacing
         */
        function generateChartLabels(sortedFunctions) {
            const labels = [];
            const prevYear = getPreviousYear();
            const currYear = getCurrentYear();
            
            sortedFunctions.forEach((func, funcIndex) => {
                // Add previous year label
                labels.push(prevYear.name);
                
                // Add column spacing between years within same function
                for (let i = 0; i < columnSpacing; i++) {
                    labels.push('');
                }
                
                // Add current year label
                labels.push(currYear.name);
                
                // Add category gap between different functions (except last one)
                if (funcIndex < sortedFunctions.length - 1) {
                    for (let i = 0; i < categoryGap; i++) {
                        labels.push('');
                    }
                }
            });
            
            return labels;
        }
        
        /**
         * Generate all datasets for the main chart (bars + trend lines)
         * @param {Array} sortedFunctions - Sorted functions array
         * @param {Array} labels - Chart labels array
         * @param {boolean} showDataLabels - Whether to show data labels
         * @param {boolean} showValues - Whether to show values
         * @param {boolean} showPercentages - Whether to show percentages
         * @param {boolean} showTrendLine - Whether to show trend lines
         * @returns {Array} Array of Chart.js datasets
         */
        function generateChartDatasets(sortedFunctions, labels, showDataLabels, showValues, showPercentages, showTrendLine) {
            const datasets = [];
            const prevYear = getPreviousYear();
            const currYear = getCurrentYear();
            
            // Generate bar datasets for each category
            categories.forEach((category, catIndex) => {
                const { dataPrev, dataCurr, trendDataPrev, trendDataCurr } = 
                    generateCategoryData(sortedFunctions, category, catIndex, labels.length);
                
                // Previous year bars
                datasets.push(createBarDataset(
                    category, 
                    prevYear, 
                    dataPrev, 
                    'previous', 
                    showDataLabels && showValues
                ));
                
                // Current year bars
                datasets.push(createBarDataset(
                    category, 
                    currYear, 
                    dataCurr, 
                    'current', 
                    showDataLabels && showValues
                ));
                
                // Trend lines (if enabled)
                if (showTrendLine && trendLineConfig[category.id]?.enabled) {
                    datasets.push(createTrendDataset(
                        category, 
                        prevYear, 
                        trendDataPrev, 
                        showDataLabels && showPercentages
                    ));
                    
                    datasets.push(createTrendDataset(
                        category, 
                        currYear, 
                        trendDataCurr, 
                        showDataLabels && showPercentages
                    ));
                }
            });
            
            return datasets;
        }
        
        /**
         * Generate data arrays for a specific category
         * @param {Array} sortedFunctions - Sorted functions
         * @param {Object} category - Category object
         * @param {number} catIndex - Category index
         * @param {number} totalLength - Total length of data array needed
         * @returns {Object} Object with data arrays for previous/current years
         */
        function generateCategoryData(sortedFunctions, category, catIndex, totalLength) {
            const dataPrev = new Array(totalLength).fill(null);
            const dataCurr = new Array(totalLength).fill(null);
            const trendDataPrev = new Array(totalLength).fill(null);
            const trendDataCurr = new Array(totalLength).fill(null);
            
            const prevYear = getPreviousYear();
            const currYear = getCurrentYear();
            
            let dataIndex = 0;
            
            sortedFunctions.forEach((func, funcIndex) => {
                // Get raw values
                const valuePrev = getDataValue(func.id, prevYear.id, catIndex);
                const valueCurr = getDataValue(func.id, currYear.id, catIndex);
                
                // Calculate percentages with 2 decimal precision
                const percPrev = getCategoryPercentage(func.id, prevYear.id, catIndex);
                const percCurr = getCategoryPercentage(func.id, currYear.id, catIndex);
                
                // Previous year data
                dataPrev[dataIndex] = valuePrev;
                trendDataPrev[dataIndex] = percPrev;
                
                // Skip column spacing
                dataIndex += columnSpacing + 1;
                
                // Current year data
                dataCurr[dataIndex] = valueCurr;
                trendDataCurr[dataIndex] = percCurr;
                
                // Move to next function group
                dataIndex += 1;
                
                // Add category gap (except for last function)
                if (funcIndex < sortedFunctions.length - 1) {
                    dataIndex += categoryGap;
                }
            });
            
            return { dataPrev, dataCurr, trendDataPrev, trendDataCurr };
        }
        
        /**
         * Create a bar dataset configuration
         * @param {Object} category - Category object
         * @param {Object} year - Year object
         * @param {Array} data - Data array
         * @param {string} yearType - 'previous' or 'current'
         * @param {boolean} showLabels - Whether to show data labels
         * @returns {Object} Chart.js dataset configuration
         */
        function createBarDataset(category, year, data, yearType, showLabels) {
            const opacity = getOpacity(yearType);
            
            return {
                label: `${category.name} ${year.name}`,
                data: data,
                backgroundColor: category.color + opacity,
                borderColor: category.color,
                borderWidth: 1,
                borderRadius: 4,
                borderSkipped: false,
                stack: 'combined',
                datalabels: {
                    display: showLabels,
                    anchor: 'center',
                    align: 'center',
                    color: textStyles.dataLabels.color,
                    font: {
                        weight: textStyles.dataLabels.fontWeight,
                        size: textStyles.dataLabels.fontSize
                    },
                    formatter: (value) => value > 0 ? value : '',
                    clip: false
                }
            };
        }
        
        /**
         * Create a trend line dataset configuration
         * @param {Object} category - Category object
         * @param {Object} year - Year object
         * @param {Array} data - Trend data array
         * @param {boolean} showLabels - Whether to show percentage labels
         * @returns {Object} Chart.js dataset configuration
         */
        function createTrendDataset(category, year, data, showLabels) {
            const config = trendLineConfig[category.id] || {};
            const trendColor = config.color || category.color;
            const thickness = config.thickness || 2;
            const pointSize = config.pointSize || 4;
            const opacity = config.opacity || 1.0;
            const showPoints = config.showPoints !== false;
            const showLine = config.showLine !== false;
            
            return {
                label: `${category.name} Trend ${year.name}`,
                data: data,
                type: 'line',
                borderColor: trendColor,
                backgroundColor: 'transparent',
                borderWidth: thickness,
                pointRadius: showPoints ? pointSize : 0,
                pointBackgroundColor: trendColor,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                showLine: showLine,
                tension: 0.2, // Smooth curve
                yAxisID: 'y1',
                opacity: opacity,
                datalabels: {
                    display: showLabels,
                    backgroundColor: 'rgba(255,255,255,0.9)',
                    borderColor: trendColor,
                    borderRadius: 4,
                    borderWidth: 1,
                    color: textStyles.dataLabels.color,
                    font: {
                        weight: textStyles.dataLabels.fontWeight,
                        size: Math.max(8, textStyles.dataLabels.fontSize - 2)
                    },
                    padding: 4,
                    formatter: (value) => value > 0 ? value.toFixed(2) + '%' : '',
                    clip: false
                }
            };
        }
        
        /**
         * Create chart options configuration for main chart
         * @param {string} chartType - Chart type ('bar' or 'horizontalBar')
         * @param {boolean} animation - Whether to enable animations
         * @param {boolean} showTrendLine - Whether trend lines are shown
         * @param {Object} prevYear - Previous year object
         * @param {Object} currYear - Current year object
         * @returns {Object} Chart.js options configuration
         */
        function createMainChartOptions(chartType, animation, showTrendLine, prevYear, currYear) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: animation ? 750 : 0,
                    easing: 'easeInOutQuart'
                },
                layout: {
                    padding: {
                        top: 50, // Space for function names
                        bottom: 20,
                        left: 10,
                        right: showTrendLine ? 60 : 10 // Space for secondary axis
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: `Quality Assurance Review Results (${prevYear.name} vs ${currYear.name})`,
                        color: textStyles.title.color,
                        font: {
                            size: textStyles.title.fontSize,
                            weight: textStyles.title.fontWeight
                        },
                        padding: 20
                    },
                    legend: {
                        display: false // We use custom legend
                    },
                    tooltip: createTooltipConfiguration(),
                    datalabels: {
                        display: false // Controlled individually per dataset
                    }
                },
                scales: createScalesConfiguration(chartType, showTrendLine),
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            };
        }
        
        /**
         * Create tooltip configuration
         * @returns {Object} Tooltip configuration
         */
        function createTooltipConfiguration() {
            return {
                enabled: true,
                mode: 'index',
                intersect: false,
                backgroundColor: 'rgba(0,0,0,0.9)',
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: '#667eea',
                borderWidth: 2,
                cornerRadius: 8,
                displayColors: true,
                titleFont: {
                    size: 14,
                    weight: 'bold'
                },
                bodyFont: {
                    size: 12
                },
                padding: 12,
                callbacks: {
                    title: function(context) {
                        if (!context.length) return '';
                        
                        const dataIndex = context[0].dataIndex;
                        const sortedFunctions = getSortedFunctions();
                        
                        // Determine which function and year this data point belongs to
                        let currentIndex = 0;
                        for (let i = 0; i < sortedFunctions.length; i++) {
                            if (dataIndex === currentIndex) {
                                return `${sortedFunctions[i].name} ${getPreviousYear().name}`;
                            } else if (dataIndex === currentIndex + columnSpacing + 1) {
                                return `${sortedFunctions[i].name} ${getCurrentYear().name}`;
                            }
                            currentIndex += 2 + columnSpacing + (i < sortedFunctions.length - 1 ? categoryGap : 0);
                        }
                        
                        return 'Data Point';
                    },
                    label: function(context) {
                        if (context.parsed.y === null) return '';
                        
                        const label = context.dataset.label;
                        const value = context.parsed.y;
                        
                        // Format based on dataset type
                        if (label.includes('Trend')) {
                            return `${label}: ${value.toFixed(2)}%`;
                        } else {
                            return `${label}: ${value}`;
                        }
                    },
                    afterBody: function(context) {
                        if (!context.length) return '';
                        
                        const dataIndex = context[0].dataIndex;
                        const sortedFunctions = getSortedFunctions();
                        
                        // Find the function for this data point
                        let func = null;
                        let yearId = null;
                        let currentIndex = 0;
                        
                        for (let i = 0; i < sortedFunctions.length; i++) {
                            if (dataIndex === currentIndex) {
                                func = sortedFunctions[i];
                                yearId = getPreviousYear().id;
                                break;
                            } else if (dataIndex === currentIndex + columnSpacing + 1) {
                                func = sortedFunctions[i];
                                yearId = getCurrentYear().id;
                                break;
                            }
                            currentIndex += 2 + columnSpacing + (i < sortedFunctions.length - 1 ? categoryGap : 0);
                        }
                        
                        if (func && yearId) {
                            const total = getFunctionYearTotal(func.id, yearId);
                            return [`Total Reviews: ${total}`];
                        }
                        
                        return '';
                    }
                }
            };
        }
        
        /**
         * Create scales configuration for chart
         * @param {string} chartType - Chart type
         * @param {boolean} showTrendLine - Whether trend lines are shown
         * @returns {Object} Scales configuration
         */
        function createScalesConfiguration(chartType, showTrendLine) {
            const isHorizontal = chartType === 'horizontalBar';
            
            const scales = {
                x: {
                    stacked: true,
                    grid: {
                        display: false
                    },
                    ticks: {
                        callback: function(value, index) {
                            const label = this.getLabelForValue(value);
                            return label === '' ? '' : label;
                        },
                        maxRotation: isHorizontal ? 0 : 45,
                        minRotation: 0,
                        color: textStyles.axisLabels.color,
                        font: {
                            size: textStyles.axisLabels.fontSize,
                            weight: textStyles.axisLabels.fontWeight
                        }
                    }
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.1)',
                        lineWidth: 1
                    },
                    ticks: {
                        color: textStyles.axisLabels.color,
                        font: {
                            size: textStyles.axisLabels.fontSize,
                            weight: textStyles.axisLabels.fontWeight
                        }
                    },
                    title: {
                        display: true,
                        text: 'Number of Accounts',
                        color: textStyles.title.color,
                        font: {
                            size: textStyles.title.fontSize,
                            weight: textStyles.title.fontWeight
                        }
                    }
                }
            };
            
            // Add secondary axis for trend lines
            if (showTrendLine) {
                scales.y1 = {
                    type: 'linear',
                    display: true,
                    position: isHorizontal ? 'top' : 'right',
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        drawOnChartArea: false
                    },
                    ticks: {
                        color: textStyles.axisLabels.color,
                        font: {
                            size: textStyles.axisLabels.fontSize,
                            weight: textStyles.axisLabels.fontWeight
                        },
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    title: {
                        display: true,
                        text: 'Percentage (%)',
                        color: textStyles.title.color,
                        font: {
                            size: textStyles.title.fontSize,
                            weight: textStyles.title.fontWeight
                        }
                    }
                };
            }
            
            return scales;
        }
        
        /**
         * Create plugin for rendering function names below the chart
         * @param {Array} sortedFunctions - Sorted functions array
         * @param {Array} labels - Chart labels array
         * @returns {Object} Chart.js plugin
         */
        function createFunctionNamePlugin(sortedFunctions, labels) {
            return {
                id: 'functionNames',
                afterDraw: function(chart) {
                    const ctx = chart.ctx;
                    const xAxis = chart.scales.x;
                    const yAxis = chart.scales.y;
                    
                    ctx.save();
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'top';
                    ctx.fillStyle = textStyles.functionNames.color;
                    ctx.font = `${textStyles.functionNames.fontWeight} ${textStyles.functionNames.fontSize}px Arial`;
                    
                    let labelIndex = 0;
                    sortedFunctions.forEach((func, funcIndex) => {
                        // Calculate center position between the two year columns for this function
                        const startPixel = xAxis.getPixelForValue(labelIndex);
                        const endPixel = xAxis.getPixelForValue(labelIndex + columnSpacing + 1);
                        const centerX = (startPixel + endPixel) / 2;
                        
                        // Position function name below the chart area
                        const yPosition = chart.chartArea.bottom + 25;
                        
                        ctx.fillText(func.name, centerX, yPosition);
                        
                        // Move to next function
                        labelIndex += 2 + columnSpacing + (funcIndex < sortedFunctions.length - 1 ? categoryGap : 0);
                    });
                    
                    ctx.restore();
                }
            };
        }
        
        // ===== TREND CHART CREATION =====
        
        /**
         * Create the trend analysis chart showing year-over-year changes
         */
        function createTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            const prevYear = getPreviousYear();
            const currYear = getCurrentYear();
            
            if (!prevYear || !currYear) {
                console.warn('Cannot create trend chart: Missing year configuration');
                return;
            }
            
            const trendData = generateTrendChartData();
            const config = {
                type: 'line',
                data: trendData,
                options: createTrendChartOptions(prevYear, currYear)
            };
            
            // Destroy existing chart and create new one
            if (trendChart) {
                trendChart.destroy();
            }
            trendChart = new Chart(ctx, config);
            
            // Update trend summary cards
            updateTrendSummary();
        }
        
        /**
         * Generate data for trend chart
         * @returns {Object} Chart.js data configuration
         */
        function generateTrendChartData() {
            const prevYear = getPreviousYear();
            const currYear = getCurrentYear();
            
            return {
                labels: functions.map(f => f.name),
                datasets: categories.map((category, catIndex) => ({
                    label: category.name,
                    data: functions.map(func => {
                        return getYearOverYearChange(func.id, catIndex);
                    }),
                    borderColor: category.color,
                    backgroundColor: category.color + '20',
                    borderWidth: 3,
                    fill: false,
                    pointRadius: 6,
                    pointBackgroundColor: category.color,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 3,
                    pointHoverRadius: 8,
                    tension: 0.3
                }))
            };
        }
        
        /**
         * Create options for trend chart
         * @param {Object} prevYear - Previous year object
         * @param {Object} currYear - Current year object
         * @returns {Object} Chart.js options configuration
         */
        function createTrendChartOptions(prevYear, currYear) {
            const animation = document.getElementById('animation')?.value === 'true';
            
            return {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: animation ? 750 : 0,
                    easing: 'easeInOutQuart'
                },
                plugins: {
                    title: {
                        display: true,
                        text: `Year-over-Year Percentage Point Change (${prevYear.name} to ${currYear.name})`,
                        color: textStyles.title.color,
                        font: {
                            size: textStyles.title.fontSize,
                            weight: textStyles.title.fontWeight
                        },
                        padding: 20
                    },
                    legend: {
                        display: true,
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            color: textStyles.legend.color,
                            font: {
                                size: textStyles.legend.fontSize,
                                weight: textStyles.legend.fontWeight
                            }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0,0,0,0.9)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#667eea',
                        borderWidth: 2,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y;
                                const sign = value >= 0 ? '+' : '';
                                return `${context.dataset.label}: ${sign}${value.toFixed(2)}pp`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: textStyles.axisLabels.color,
                            font: {
                                size: textStyles.axisLabels.fontSize,
                                weight: textStyles.axisLabels.fontWeight
                            }
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            color: textStyles.axisLabels.color,
                            font: {
                                size: textStyles.axisLabels.fontSize,
                                weight: textStyles.axisLabels.fontWeight
                            },
                            callback: function(value) {
                                const sign = value >= 0 ? '+' : '';
                                return sign + value + 'pp';
                            }
                        },
                        title: {
                            display: true,
                            text: 'Percentage Point Change',
                            color: textStyles.title.color,
                            font: {
                                size: textStyles.title.fontSize,
                                weight: textStyles.title.fontWeight
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            };
        }
        
        // ===== MAXIMIZED CHART CREATION =====
        
        /**
         * Create maximized version of the main chart
         */
        function createMaximizedChart() {
            try {
                const canvas = document.getElementById('qaChartMaximized');
                if (!canvas) {
                    console.warn('Maximized chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('Cannot get 2D context for maximized chart');
                    return;
                }
                const sortedFunctions = getSortedFunctions();
                const prevYear = getPreviousYear();
                const currYear = getCurrentYear();
                
                if (!prevYear || !currYear) return;
                
                // Use same data generation as main chart
                const labels = generateChartLabels(sortedFunctions);
                const showDataLabels = document.getElementById('showDataLabels')?.checked || false;
                const showValues = document.getElementById('showValues')?.checked || false;
                const showPercentages = document.getElementById('showPercentages')?.checked || false;
                const showTrendLine = document.getElementById('showTrendLine')?.checked || false;
                const chartType = document.getElementById('chartType')?.value || 'bar';
                
                const datasets = generateChartDatasets(
                    sortedFunctions, 
                    labels, 
                    showDataLabels, 
                    showValues, 
                    showPercentages, 
                    showTrendLine
                );
                
                // Create maximized chart configuration with enhanced styling
                const config = {
                    type: chartType,
                    data: { labels, datasets },
                    options: {
                        ...createMainChartOptions(chartType, true, showTrendLine, prevYear, currYear),
                        layout: {
                            padding: {
                                top: 60,
                                bottom: 40,
                                left: 20,
                                right: showTrendLine ? 80 : 20
                            }
                        },
                        plugins: {
                            ...createMainChartOptions(chartType, true, showTrendLine, prevYear, currYear).plugins,
                            title: {
                                display: true,
                                text: `Quality Assurance Review Results (${prevYear.name} vs ${currYear.name}) - Maximized View`,
                                color: textStyles.title.color,
                                font: {
                                    size: Math.max(20, textStyles.title.fontSize + 4),
                                    weight: textStyles.title.fontWeight
                                },
                                padding: 30
                            }
                        }
                    },
                    plugins: [createFunctionNamePlugin(sortedFunctions, labels)]
                };
                
                // Create maximized chart
                if (maximizedChart) {
                    maximizedChart.destroy();
                }
                maximizedChart = new Chart(ctx, config);
            } catch (error) {
                console.error('Error creating maximized chart:', error);
                announceChange('Error creating maximized chart view');
                // Fallback: close the maximized view
                toggleChartMaximize();
            }
        }
        
        // ===== CHART ACCESSIBILITY =====
        
        /**
         * Update chart accessibility attributes and descriptions
         */
        function updateChartAccessibility() {
            const canvas = document.getElementById('qaChart');
            const prevYear = getPreviousYear();
            const currYear = getCurrentYear();
            
            if (!canvas || !prevYear || !currYear) return;
            
            let description = `Interactive chart showing quality assurance review results comparing ${prevYear.name} and ${currYear.name}. `;
            
            // Add summary statistics
            functions.forEach(func => {
                const prevTotal = getFunctionYearTotal(func.id, prevYear.id);
                const currTotal = getFunctionYearTotal(func.id, currYear.id);
                const prevPassRate = getCategoryPercentage(func.id, prevYear.id, 0);
                const currPassRate = getCategoryPercentage(func.id, currYear.id, 0);
                
                description += `${func.name}: ${prevYear.name} had ${prevTotal} reviews with ${prevPassRate.toFixed(1)}% pass rate, ${currYear.name} had ${currTotal} reviews with ${currPassRate.toFixed(1)}% pass rate. `;
            });
            
            // Add interaction instructions
            description += 'Use arrow keys to navigate chart elements. Press Tab to access chart controls.';
            
            canvas.setAttribute('aria-label', description);
            canvas.setAttribute('role', 'img');
            canvas.setAttribute('tabindex', '0');
        }
        
        // ===== CHART INTEGRATION FUNCTIONS =====
        
        /**
         * Create both main and trend charts
         * Main entry point for chart creation
         */
        function createCharts() {
            try {
                createMainChart();
                createTrendChart();
                
                // Update related UI elements
                updateShadingPreview();
                updateTextStyleDisplays();
                
                console.log('Charts created successfully');
            } catch (error) {
                console.error('Error creating charts:', error);
                announceChange('Error creating charts. Please check your data.');
            }
        }
        
        // ===== INITIALIZATION FUNCTION =====
        
        /**
         * Initialize the entire dashboard
         * Sets up all components and renders initial state
         */
        function initializeDashboard() {
            try {
                // Initialize text style displays
                updateTextStyleDisplays();
                
                // Render all UI components
                renderYears();
                renderCategories();
                renderFunctions();
                renderTrendLineControls();
                renderDataInput();
                
                // Create initial charts
                createCharts();
                
                // Update shading preview
                updateShadingPreview();
                
                // Toggle data label options based on initial state
                toggleDataLabelOptions();
                
                // Initialize spacing controls
                document.getElementById('columnSpacingValue').textContent = columnSpacing;
                document.getElementById('categoryGapValue').textContent = categoryGap;
                
                // Set up event listeners
                initializeEventListeners();
                
                // Create announcement element for accessibility
                if (!document.getElementById('announcement')) {
                    const announcement = document.createElement('div');
                    announcement.id = 'announcement';
                    announcement.className = 'sr-only';
                    announcement.setAttribute('aria-live', 'polite');
                    announcement.setAttribute('aria-atomic', 'true');
                    document.body.appendChild(announcement);
                }
                
                // Initial accessibility update
                updateChartAccessibility();
                
                // Announce successful initialization
                announceChange('Dashboard initialized successfully');
                
                console.log('Dashboard initialization complete');
                
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                
                // Show error message to user
                const errorMessage = document.createElement('div');
                errorMessage.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #f44336;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    z-index: 10000;
                    font-weight: bold;
                `;
                errorMessage.textContent = 'Error initializing dashboard. Please refresh the page.';
                document.body.appendChild(errorMessage);
                
                // Auto-remove error message after 5 seconds
                setTimeout(() => {
                    if (errorMessage.parentElement) {
                        errorMessage.remove();
                    }
                }, 5000);
            }
        }
        
        // ===== DATA EXPORT & IMPORT FUNCTIONS =====
        
        /**
         * Export all dashboard configuration and data as JSON
         * @returns {string} JSON string of complete dashboard state
         */
        function exportDashboardData() {
            const dashboardState = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                configuration: {
                    years: years,
                    categories: categories,
                    functions: functions,
                    functionData: functionData,
                    textStyles: textStyles,
                    trendLineConfig: trendLineConfig,
                    columnSpacing: columnSpacing,
                    categoryGap: categoryGap
                },
                metadata: {
                    exportCount: exportCounter,
                    totalFunctions: functions.length,
                    totalCategories: categories.length,
                    totalYears: years.length
                }
            };
            
            return JSON.stringify(dashboardState, null, 2);
        }
        function validateImportedData(data) {
            const errors = [];
            
            // Check required fields
            if (!data.configuration) {
                errors.push('Missing configuration object');
                return { valid: false, errors };
            }
            
            const config = data.configuration;
            
            // Validate arrays
            if (!Array.isArray(config.years) || config.years.length === 0) {
                errors.push('Invalid or empty years array');
            }
            
            if (!Array.isArray(config.categories) || config.categories.length === 0) {
                errors.push('Invalid or empty categories array');
            }
            
            if (!Array.isArray(config.functions) || config.functions.length === 0) {
                errors.push('Invalid or empty functions array');
            }
            
            // Validate data structure integrity
            if (config.functionData && typeof config.functionData === 'object') {
                for (const funcId in config.functionData) {
                    if (!config.functions.some(f => f.id === funcId)) {
                        errors.push(`Data exists for unknown function: ${funcId}`);
                    }
                }
            }
            
            return {
                valid: errors.length === 0,
                errors: errors
            };
        }
        /**
         * Import dashboard configuration from JSON data
         * @param {string} jsonData - JSON string containing dashboard state
         * @returns {boolean} Success status
         */
        function importDashboardData(jsonData) {
            try {
                const dashboardState = JSON.parse(jsonData);

                // Validate before importing
                const validation = validateImportedData(dashboardState);
                if (!validation.valid) {
                    console.error('Import validation failed:', validation.errors);
                    announceChange('Import failed: ' + validation.errors.join(', '));
                    return false;
                }                
                // Validate data structure
                if (!dashboardState.configuration) {
                    throw new Error('Invalid data format: missing configuration');
                }
                
                const config = dashboardState.configuration;
                
                // Import data with validation
                if (config.years && Array.isArray(config.years)) {
                    years = config.years;
                }
                if (config.categories && Array.isArray(config.categories)) {
                    categories = config.categories;
                }
                if (config.functions && Array.isArray(config.functions)) {
                    functions = config.functions;
                }
                if (config.functionData && typeof config.functionData === 'object') {
                    functionData = config.functionData;
                }
                if (config.textStyles && typeof config.textStyles === 'object') {
                    textStyles = { ...textStyles, ...config.textStyles };
                }
                if (config.trendLineConfig && typeof config.trendLineConfig === 'object') {
                    trendLineConfig = { ...trendLineConfig, ...config.trendLineConfig };
                }
                if (typeof config.columnSpacing === 'number') {
                    columnSpacing = config.columnSpacing;
                }
                if (typeof config.categoryGap === 'number') {
                    categoryGap = config.categoryGap;
                }
                
                // Re-initialize dashboard with imported data
                initializeDashboard();
                
                announceChange('Dashboard data imported successfully');
                return true;
                
            } catch (error) {
                console.error('Error importing dashboard data:', error);
                announceChange('Error importing data. Please check the file format.');
                return false;
            }
        }
        
        // ===== PERFORMANCE OPTIMIZATION FUNCTIONS =====
        
        /**
         * Optimize chart performance for large datasets
         */
        function optimizeChartPerformance() {
            // Disable animations for large datasets
            if (functions.length > 10 || categories.length > 8) {
                const animationSelect = document.getElementById('animation');
                if (animationSelect && animationSelect.value === 'true') {
                    animationSelect.value = 'false';
                    announceChange('Animations disabled for better performance with large dataset');
                }
            }
            
            // Reduce point sizes for trend lines if there are many data points
            const totalDataPoints = functions.length * years.length * categories.length;
            if (totalDataPoints > 100) {
                Object.keys(trendLineConfig).forEach(categoryId => {
                    if (trendLineConfig[categoryId].pointSize > 3) {
                        trendLineConfig[categoryId].pointSize = 3;
                    }
                });
            }
        }
        
        /**
         * Clean up chart instances and event listeners
         */
        function cleanup() {
            // Destroy chart instances
            if (chart) {
                chart.destroy();
                chart = null;
            }
            if (trendChart) {
                trendChart.destroy();
                trendChart = null;
            }
            if (maximizedChart) {
                maximizedChart.destroy();
                maximizedChart = null;
            }
            
            // Clear exported images from memory
            exportedImages = [];
            exportCounter = 1;
            
            console.log('Dashboard cleanup completed');
        }
        
        // ===== ERROR HANDLING & VALIDATION =====
        
        /**
         * Validate chart data before rendering
         * @returns {Object} Validation result with status and issues
         */
        function validateChartData() {
            const issues = [];
            
            // Check for minimum requirements
            if (functions.length === 0) {
                issues.push('No functions configured');
            }
            if (categories.length === 0) {
                issues.push('No categories configured');
            }
            if (years.length < 2) {
                issues.push('At least two years required for comparison');
            }
            
            // Check for previous and current year designation
            const hasPrevious = years.some(y => y.type === 'previous');
            const hasCurrent = years.some(y => y.type === 'current');
            
            if (!hasPrevious) {
                issues.push('No year designated as "previous"');
            }
            if (!hasCurrent) {
                issues.push('No year designated as "current"');
            }
            
            // Check data completeness
            functions.forEach(func => {
                years.forEach(year => {
                    if (!functionData[func.id] || !functionData[func.id][year.id]) {
                        issues.push(`Missing data for ${func.name} in ${year.name}`);
                    } else if (functionData[func.id][year.id].length !== categories.length) {
                        issues.push(`Incomplete data for ${func.name} in ${year.name}`);
                    }
                });
            });
            
            return {
                valid: issues.length === 0,
                issues: issues
            };
        }
        
        /**
         * Handle chart creation errors gracefully
         * @param {Error} error - Error object
         * @param {string} context - Context where error occurred
         */
        function handleChartError(error, context = 'chart creation') {
            console.error(`Error in ${context}:`, error);
            
            // Show user-friendly error message
            const errorContainer = document.createElement('div');
            errorContainer.className = 'chart-error';
            errorContainer.style.cssText = `
                background: #ffebee;
                border: 2px solid #f44336;
                border-radius: 8px;
                padding: 20px;
                margin: 20px;
                color: #c62828;
                text-align: center;
            `;
            errorContainer.innerHTML = `
                <h3>Chart Error</h3>
                <p>There was an error creating the charts. Please check your data configuration.</p>
                <button onclick="this.parentElement.remove(); createCharts();" 
                        style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                    Retry
                </button>
            `;
            
            // Replace chart container content with error message
            const chartContainer = document.getElementById('chartContainer');
            if (chartContainer) {
                chartContainer.appendChild(errorContainer);
            }
            
            announceChange(`Error in ${context}. Please check your configuration.`);
        }
        
        // ===== BROWSER COMPATIBILITY FUNCTIONS =====
        
        /**
         * Check browser compatibility and provide fallbacks
         * @returns {Object} Compatibility status and missing features
         */
        function checkBrowserCompatibility() {
            const features = {
                canvas: !!document.createElement('canvas').getContext,
                localStorage: typeof(Storage) !== 'undefined',
                css3: typeof(document.body.style.borderRadius) !== 'undefined',
                es6: typeof(Array.from) === 'function'
            };
            
            const missing = Object.keys(features).filter(key => !features[key]);
            
            if (missing.length > 0) {
                console.warn('Missing browser features:', missing);
                
                // Show compatibility warning
                const warning = document.createElement('div');
                warning.style.cssText = `
                    background: #fff3cd;
                    border: 2px solid #ffc107;
                    border-radius: 8px;
                    padding: 15px;
                    margin: 10px;
                    color: #856404;
                `;
                warning.innerHTML = `
                    <strong>Browser Compatibility Notice:</strong>
                    Some features may not work properly in your browser. 
                    Please consider upgrading to a modern browser for the best experience.
                `;
                
                document.body.insertBefore(warning, document.body.firstChild);
            }
            
            return {
                compatible: missing.length === 0,
                missing: missing,
                features: features
            };
        }
        
        // ===== DASHBOARD INITIALIZATION ON PAGE LOAD =====
        
        /**
         * Initialize dashboard when DOM is ready
         */
        document.addEventListener('DOMContentLoaded', function() {
            // Check browser compatibility
            const compatibility = checkBrowserCompatibility();
            
            if (compatibility.compatible) {
                // Initialize dashboard
                initializeDashboard();
                
                // Set up performance optimization
                optimizeChartPerformance();
                
                console.log('Dashboard ready and fully functional');
            } else {
                console.warn('Dashboard initialized with limited functionality due to browser compatibility issues');
                
                // Try to initialize anyway with fallbacks
                try {
                    initializeDashboard();
                } catch (error) {
                    handleChartError(error, 'dashboard initialization');
                }
            }
        });
        
        // ===== WINDOW UNLOAD CLEANUP =====
        
        /**
         * Clean up resources when page is unloaded
         */
        window.addEventListener('beforeunload', function() {
            cleanup();
        });
        
        // ===== GLOBAL ERROR HANDLING =====
        
        /**
         * Global error handler for uncaught errors
         */
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            handleChartError(event.error, 'global error handler');
        });
        
        // ===== EXPOSED GLOBAL FUNCTIONS FOR DEBUGGING =====
        
        /**
         * Expose useful functions globally for debugging and testing
         */
        window.dashboardDebug = {
            exportData: exportDashboardData,
            importData: importDashboardData,
            validateData: validateDataIntegrity,
            validateChart: validateChartData,
            recreateCharts: createCharts,
            cleanup: cleanup,
            getState: () => ({
                functions,
                categories,
                years,
                functionData,
                textStyles,
                trendLineConfig,
                exportedImages
            })
        };
        
        /* ===========================================
           END OF PART 5: CHART CREATION & ADVANCED FEATURES
           =========================================== */
    </script>
</body>
</html>
